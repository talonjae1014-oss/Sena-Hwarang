<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ê¸¸ë“œì „ ê³µê²© ì¶”ì²œ</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  update,
  push,
  set
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* =====================
   Firebase ì„¤ì •
===================== */
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentPath = "";

/* =====================
   ë°©ì–´íŒ€ ë¶ˆëŸ¬ì˜¤ê¸°
===================== */
onValue(ref(db, "defenseTeams"), (snapshot) => {
  const data = snapshot.val();
  const select = document.getElementById("defenseSelect");
  select.innerHTML = "";

  if (!data) return;

  for (let key in data) {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = data[key].name;
    select.appendChild(option);
  }

  loadAttackTeams(select.value);
});

/* =====================
   ë°©ì–´íŒ€ ì¶”ê°€
===================== */
window.addDefenseTeam = function () {
  const name = document.getElementById("newDefenseName").value.trim();
  if (!name) {
    alert("ë°©ì–´íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const newRef = push(ref(db, "defenseTeams"));
  set(newRef, {
    name: name,
    attackTeams: {}
  });

  document.getElementById("newDefenseName").value = "";
};

/* =====================
   ê³µê²©íŒ€ ë¶ˆëŸ¬ì˜¤ê¸°
===================== */
window.loadAttackTeams = function (defenseKey) {
  const list = document.getElementById("attackList");
  list.innerHTML = "";

  if (!defenseKey) return;

  onValue(ref(db, `defenseTeams/${defenseKey}/attackTeams`), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    for (let key in data) {
      const btn = document.createElement("button");
      btn.textContent = data[key].name;
      btn.onclick = () => selectAttack(defenseKey, key);
      list.appendChild(btn);
    }
  });
};

/* =====================
   ê³µê²©íŒ€ ì¶”ê°€
===================== */
window.addAttackTeam = function () {
  const defenseKey = document.getElementById("defenseSelect").value;
  if (!defenseKey) {
    alert("ë°©ì–´íŒ€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  const name = document.getElementById("newAttackName").value.trim();
  const weapon = document.getElementById("newWeapon").value.trim();
  const armor = document.getElementById("newArmor").value.trim();
  const accessory = document.getElementById("newAccessory").value.trim();

  if (!name) {
    alert("ê³µê²©íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const newRef = push(ref(db, `defenseTeams/${defenseKey}/attackTeams`));
  set(newRef, {
    name: name,
    items: {
      weapon: weapon,
      armor: armor,
      accessory: accessory
    },
    win: 0,
    lose: 0
  });

  document.getElementById("newAttackName").value = "";
  document.getElementById("newWeapon").value = "";
  document.getElementById("newArmor").value = "";
  document.getElementById("newAccessory").value = "";
};

/* =====================
   ê³µê²©íŒ€ ì„ íƒ
===================== */
window.selectAttack = function (defenseKey, attackKey) {
  currentPath = `defenseTeams/${defenseKey}/attackTeams/${attackKey}`;

  onValue(ref(db, currentPath), (snapshot) => {
    const d = snapshot.val();
    if (!d) return;

    document.getElementById("weapon").textContent = d.items.weapon || "-";
    document.getElementById("armor").textContent = d.items.armor || "-";
    document.getElementById("accessory").textContent = d.items.accessory || "-";
    document.getElementById("win").textContent = d.win;
    document.getElementById("lose").textContent = d.lose;

    const total = d.win + d.lose;
    const rate = total === 0 ? 0 : Math.round((d.win / total) * 100);
    document.getElementById("rate").textContent = rate;
  });
};

/* =====================
   ìŠ¹ / íŒ¨ ì²˜ë¦¬
===================== */
window.addWin = function () {
  if (!currentPath) return;
  update(ref(db, currentPath), {
    win: Number(document.getElementById("win").textContent) + 1
  });
};

window.addLose = function () {
  if (!currentPath) return;
  update(ref(db, currentPath), {
    lose: Number(document.getElementById("lose").textContent) + 1
  });
};
</script>

<style>
body { font-family: sans-serif; padding: 12px; background:#111; color:#fff }
select, input, button { width:100%; padding:12px; margin-top:8px; font-size:16px }
button { background:#333; color:white; border:none; border-radius:6px }
.stat { margin-top:10px }
</style>
</head>

<body>

<h3>â• ë°©ì–´íŒ€ ì¶”ê°€</h3>
<input id="newDefenseName" placeholder="ë°©ì–´íŒ€ ì´ë¦„" />
<button onclick="addDefenseTeam()">ë°©ì–´íŒ€ ì¶”ê°€</button>

<h3>ğŸ›¡ ë°©ì–´íŒ€ ì„ íƒ</h3>
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>

<h3>â• ê³µê²©íŒ€ ì¶”ê°€</h3>
<input id="newAttackName" placeholder="ê³µê²©íŒ€ ì´ë¦„" />
<input id="newWeapon" placeholder="ë¬´ê¸°" />
<input id="newArmor" placeholder="ë°©ì–´êµ¬" />
<input id="newAccessory" placeholder="ë³´ì¡° ì•„ì´í…œ" />
<button onclick="addAttackTeam()">ê³µê²©íŒ€ ì¶”ê°€</button>

<h3>âš” ê³µê²©íŒ€</h3>
<div id="attackList"></div>

<h3>ğŸ’ ì•„ì´í…œ</h3>
<div class="stat">ë¬´ê¸°: <span id="weapon"></span></div>
<div class="stat">ë°©ì–´êµ¬: <span id="armor"></span></div>
<div class="stat">ë³´ì¡°: <span id="accessory"></span></div>

<h3>ğŸ“Š ì „ì </h3>
<button onclick="addWin()">ìŠ¹</button>
<button onclick="addLose()">íŒ¨</button>

<div class="stat">ìŠ¹: <span id="win">0</span> / íŒ¨: <span id="lose">0</span></div>
<div class="stat">ìŠ¹ë¥ : <span id="rate">0</span>%</div>

</body>
</html>
