<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ê¸¸ë“œì „ ê³µê²© ì¶”ì²œ</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  update,
  push,
  set
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentPath = "";

/* ë°©ì–´íŒ€ ë¶ˆëŸ¬ì˜¤ê¸° */
onValue(ref(db, "defenseTeams"), (snapshot) => {
  const data = snapshot.val();
  const select = document.getElementById("defenseSelect");
  select.innerHTML = "";
  if (!data) return;

  for (let key in data) {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = data[key].name;
    select.appendChild(option);
  }
  loadAttackTeams(select.value);
});

/* ë°©ì–´íŒ€ ì¶”ê°€ */
window.addDefenseTeam = function () {
  const name = document.getElementById("newDefenseName").value.trim();
  if (!name) return alert("ë°©ì–´íŒ€ ì´ë¦„ ì…ë ¥");

  const newRef = push(ref(db, "defenseTeams"));
  set(newRef, { name, attackTeams: {} });
  document.getElementById("newDefenseName").value = "";
};

/* ê³µê²©íŒ€ ë¶ˆëŸ¬ì˜¤ê¸° */
window.loadAttackTeams = function (defenseKey) {
  const list = document.getElementById("attackList");
  list.innerHTML = "";
  if (!defenseKey) return;

  onValue(ref(db, `defenseTeams/${defenseKey}/attackTeams`), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    for (let key in data) {
      const btn = document.createElement("button");
      btn.textContent = data[key].name;
      btn.onclick = () => selectAttack(defenseKey, key);
      list.appendChild(btn);
    }
  });
};

/* ê³µê²©íŒ€ ì¶”ê°€ */
window.addAttackTeam = function () {
  const defenseKey = document.getElementById("defenseSelect").value;
  if (!defenseKey) return alert("ë°©ì–´íŒ€ ì„ íƒ");

  const name = document.getElementById("newAttackName").value.trim();
  if (!name) return alert("ê³µê²©íŒ€ ì´ë¦„ ì…ë ¥");

  const type = document.getElementById("newType").value;
  const ring = document.getElementById("newRing").value.trim();
  const armorDesc = document.getElementById("newArmorDesc").value.trim();

  const newRef = push(ref(db, `defenseTeams/${defenseKey}/attackTeams`));
  set(newRef, {
    name,
    items: {
      type,
      ring,
      armorDesc
    },
    win: 0,
    lose: 0
  });

  document.getElementById("newAttackName").value = "";
  document.getElementById("newRing").value = "";
  document.getElementById("newArmorDesc").value = "";
};

/* ê³µê²©íŒ€ ì„ íƒ */
window.selectAttack = function (defenseKey, attackKey) {
  currentPath = `defenseTeams/${defenseKey}/attackTeams/${attackKey}`;

  onValue(ref(db, currentPath), (snapshot) => {
    const d = snapshot.val();
    if (!d) return;

    document.getElementById("type").textContent = d.items.type;
    document.getElementById("ring").textContent = d.items.ring || "-";
    document.getElementById("armorDesc").textContent = d.items.armorDesc || "-";
    document.getElementById("win").textContent = d.win;
    document.getElementById("lose").textContent = d.lose;

    const t = d.win + d.lose;
    document.getElementById("rate").textContent =
      t === 0 ? 0 : Math.round((d.win / t) * 100);
  });
};

/* ìŠ¹ / íŒ¨ */
window.addWin = () => currentPath && update(ref(db, currentPath), {
  win: Number(document.getElementById("win").textContent) + 1
});
window.addLose = () => currentPath && update(ref(db, currentPath), {
  lose: Number(document.getElementById("lose").textContent) + 1
});
</script>

<style>
body { background:#111; color:#fff; padding:12px; font-family:sans-serif }
input, select, textarea, button {
  width:100%; padding:12px; margin-top:8px; font-size:16px
}
button { background:#333; color:#fff; border:none; border-radius:6px }
.stat { margin-top:10px }
pre { white-space:pre-wrap }
</style>
</head>

<body>

<h3>â• ë°©ì–´íŒ€ ì¶”ê°€</h3>
<input id="newDefenseName" placeholder="ë°©ì–´íŒ€ ì´ë¦„" />
<button onclick="addDefenseTeam()">ë°©ì–´íŒ€ ì¶”ê°€</button>

<h3>ğŸ›¡ ë°©ì–´íŒ€ ì„ íƒ</h3>
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>

<h3>â• ê³µê²©íŒ€ ì¶”ê°€</h3>
<input id="newAttackName" placeholder="ê³µê²©íŒ€ ì´ë¦„" />

<select id="newType">
  <option value="ì†ê³µ">ì†ê³µ</option>
  <option value="ë‚´ì‹¤">ë‚´ì‹¤</option>
</select>

<input id="newRing" placeholder="ë°˜ì§€ ì¶”ì²œ" />

<textarea id="newArmorDesc" rows="4"
  placeholder="ë°©ì–´êµ¬ ì¶”ì²œ (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)"></textarea>

<button onclick="addAttackTeam()">ê³µê²©íŒ€ ì¶”ê°€</button>

<h3>âš” ê³µê²©íŒ€</h3>
<div id="attackList"></div>

<h3>ğŸ’ ì•„ì´í…œ</h3>
<div class="stat">ìœ í˜•: <span id="type"></span></div>
<div class="stat">ë°˜ì§€ ì¶”ì²œ: <span id="ring"></span></div>
<div class="stat">ë°©ì–´êµ¬ ì¶”ì²œ:</div>
<pre id="armorDesc"></pre>

<h3>ğŸ“Š ì „ì </h3>
<button onclick="addWin()">ìŠ¹</button>
<button onclick="addLose()">íŒ¨</button>
<div class="stat">ìŠ¹: <span id="win">0</span> / íŒ¨: <span id="lose">0</span></div>
<div class="stat">ìŠ¹ë¥ : <span id="rate">0</span>%</div>

</body>
</html>
