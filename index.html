<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_PW = "1513";

let currentUser = "";
let currentDefenseKey = "";
let currentAttackKey = "";
let currentDefenseName = "";
let currentAttackName = "";
let adminOpened = false;

/* ë¡œê·¸ì¸ */
window.enterSite = () => {
  const n = nicknameInput.value.trim();
  if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
  currentUser = n;
  localStorage.setItem("guildUser", n);
  loginScreen.style.display = "none";
  mainUI.style.display = "block";
};

window.onload = () => {
  const saved = localStorage.getItem("guildUser");
  if (saved) {
    currentUser = saved;
    loginScreen.style.display = "none";
    mainUI.style.display = "block";
  }
};

/* ê´€ë¦¬ì */
function checkPW() {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if (pw !== ADMIN_PW) {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤");
    return false;
  }
  return true;
}

window.toggleAdmin = () => {
  if (!adminOpened) {
    if (!checkPW()) return;
    adminOpened = true;
    adminPanel.style.display = "block";
    adminToggleBtn.textContent = "âˆ’ ê´€ë¦¬ì ë‹«ê¸°";
    loadLogs();
  } else {
    adminOpened = false;
    adminPanel.style.display = "none";
    adminToggleBtn.textContent = "+ ê´€ë¦¬ììš©";
  }
};

/* ë°©ì–´íŒ€ */
onValue(ref(db, "defenseTeams"), snap => {
  defenseSelect.innerHTML = "";
  const d = snap.val();
  if (!d) return;

  Object.entries(d).forEach(([k, v]) => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = v.name;
    defenseSelect.appendChild(o);
  });

  loadAttackTeams(defenseSelect.value);
});

/* ê³µê²©íŒ€ ëª©ë¡ */
window.loadAttackTeams = (defKey) => {
  currentDefenseKey = defKey;

  onValue(ref(db, `defenseTeams/${defKey}`), snap => {
    const def = snap.val();
    if (!def) return;

    currentDefenseName = def.name;
    attackList.innerHTML = "";

    const teams = Object.entries(def.attackTeams || {}).map(([k, v]) => {
      const total = (v.win || 0) + (v.lose || 0);
      const rate = total ? Math.round(v.win / total * 100) : 0;
      return { key: k, ...v, rate };
    }).sort((a, b) => b.rate - a.rate);

    teams.forEach(t => {
      const btn = document.createElement("button");
      btn.textContent = `${t.rate >= 70 ? "ğŸ”¥ " : ""}${t.name} (${t.rate}%)`;
      btn.onclick = () => selectAttack(defKey, t.key);
      attackList.appendChild(btn);
    });
  });
};

/* ê³µê²©íŒ€ ì„ íƒ */
window.selectAttack = (dKey, aKey) => {
  currentAttackKey = aKey;

  onValue(ref(db, `defenseTeams/${dKey}/attackTeams/${aKey}`), snap => {
    const d = snap.val();
    if (!d) return;

    currentAttackName = d.name;

    typeView.textContent = d.type || "-";
    ringView.textContent = d.ring || "-";
    armorView.textContent = d.armor || "-";
    skillView.textContent = d.skill || "-";

    win.textContent = d.win || 0;
    lose.textContent = d.lose || 0;

    const total = (d.win || 0) + (d.lose || 0);
    rate.textContent = total ? Math.round(d.win / total * 100) : 0;
  });
};

/* ë¡œê·¸ */
function saveLog(result) {
  push(ref(db, "logs"), {
    user: currentUser,
    defense: currentDefenseName,
    attack: currentAttackName,
    result,
    time: Date.now()
  });
}

/* ìŠ¹ / íŒ¨ */
window.addWin = () => {
  if (!currentAttackKey) return;
  if (!confirm("ìŠ¹ë¦¬í•˜ì…¨ë‚˜ìš”?\nì¥ë‚œìœ¼ë¡œ ëˆ„ë¥´ë©´ ê¸¸ë§ˆê°€ ë§¤ìš° í™”ë‚©ë‹ˆë‹¤.")) return;
  update(ref(db, `defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`), {
    win: +win.textContent + 1
  });
  saveLog("WIN");
};

window.addLose = () => {
  if (!currentAttackKey) return;
  if (!confirm("íŒ¨ë°°í•˜ì…¨ë‚˜ìš”?\nì¥ë‚œìœ¼ë¡œ ëˆ„ë¥´ë©´ ê¸¸ë§ˆê°€ ë§¤ìš° í™”ë‚©ë‹ˆë‹¤.")) return;
  update(ref(db, `defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`), {
    lose: +lose.textContent + 1
  });
  saveLog("LOSE");
};

/* ë¡œê·¸ + ì‚¬ëŒë³„ í†µê³„ */
function loadLogs() {
  onValue(ref(db, "logs"), snap => {
    logList.innerHTML = "";
    statList.innerHTML = "";

    const data = snap.val();
    if (!data) return;

    const stats = {};

    Object.values(data).reverse().forEach(l => {
      const div = document.createElement("div");
      div.textContent =
        `[${new Date(l.time).toLocaleString()}] ${l.user} | ${l.defense} â†’ ${l.attack} | ${l.result}`;
      logList.appendChild(div);

      if (!stats[l.user]) stats[l.user] = { win: 0, lose: 0 };
      l.result === "WIN" ? stats[l.user].win++ : stats[l.user].lose++;
    });

    Object.entries(stats).forEach(([u, s]) => {
      const total = s.win + s.lose;
      const rate = total ? Math.round(s.win / total * 100) : 0;
      const div = document.createElement("div");
      div.textContent = `${u} | ìŠ¹ ${s.win} / íŒ¨ ${s.lose} | ${rate}%`;
      statList.appendChild(div);
    });
  });
}
</script>

<style>
body{background:#111;color:#fff;font-family:sans-serif;padding:12px}
button,input,select{width:100%;margin-top:8px;padding:12px}
button{background:#333;color:#fff;border:none;border-radius:6px}
.winBtn{background:#4aa3ff}
.loseBtn{background:#ff5c5c}
.adminToggle{background:#f1c40f;color:#000;font-weight:bold}

.login-screen{
  position:fixed; inset:0;
  background:linear-gradient(rgba(0,0,0,.7),rgba(0,0,0,.9));
  display:flex;align-items:center;justify-content:center;
}
.login-box{background:#000c;padding:30px;border-radius:14px;text-align:center}

.admin{display:none;margin-top:20px;border-top:2px solid #444;padding-top:15px}
.logBox{max-height:200px;overflow:auto;border:1px solid #444;padding:8px}
</style>
</head>

<body>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h1>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</h1>
    <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
    <button onclick="enterSite()">ì…ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="mainUI" style="display:none">

<h3>ğŸ¯ ê³µê²©í•  ëŒ€ìƒ</h3>
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>

<h3>âš” ê³µê²©íŒ€ ëª©ë¡</h3>
<div id="attackList"></div>

<h3>ğŸ“¦ ì„¸íŒ…</h3>
<div>íƒ€ì… : <span id="typeView"></span></div>
<div>ë°˜ì§€ : <span id="ringView"></span></div>
<div>ë°©ì–´êµ¬ : <span id="armorView"></span></div>
<div>ìŠ¤í‚¬ ìˆœì„œ : <span id="skillView"></span></div>

<h3>ğŸ“Š ì „ì </h3>
<button class="winBtn" onclick="addWin()">ìŠ¹</button>
<button class="loseBtn" onclick="addLose()">íŒ¨</button>
<div>ìŠ¹ <span id="win">0</span> / íŒ¨ <span id="lose">0</span> / ìŠ¹ë¥  <span id="rate">0</span>%</div>

<button id="adminToggleBtn" class="adminToggle" onclick="toggleAdmin()">+ ê´€ë¦¬ììš©</button>

<div id="adminPanel" class="admin">
  <h3>ğŸ“œ ë¡œê·¸</h3>
  <div id="logList" class="logBox"></div>
  <h3>ğŸ“Š ì‚¬ëŒë³„ ìŠ¹ë¥ </h3>
  <div id="statList" class="logBox"></div>
</div>

</div>
</body>
</html>
