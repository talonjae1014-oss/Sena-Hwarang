<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ (Glass Edition)</title>
<style>
  /* --- [ìŠ¤íƒ€ì¼] Glassmorphism (ìœ ë¦¬ ëª¨í”¼ì¦˜) & Dark UI --- */
  :root {
    --bg-color: #050505;
    --text-main: #f0f0f0;
    --text-sub: #a0a0a0;
    --accent: #4facfe; /* í•˜ëŠ˜ìƒ‰ í¬ì¸íŠ¸ */
    
    /* ìœ ë¦¬ íš¨ê³¼ ë³€ìˆ˜ */
    --glass-bg: rgba(255, 255, 255, 0.03);
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    --glass-blur: blur(10px);
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-main);
    font-family: 'Suit', sans-serif;
    margin: 0;
    padding: 20px;
    padding-bottom: 100px;
  }

  h2, h3, h4 { margin-top: 0; color: #fff; font-weight: 700; }
  
  /* ê³µí†µ ë²„íŠ¼ & ì…ë ¥ì°½ */
  button {
    cursor: pointer; border: none; padding: 10px 15px; border-radius: 8px;
    font-weight: bold; transition: 0.2s;
  }
  input, select, textarea {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid #444;
    color: #fff;
    padding: 12px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 8px;
  }

  /* --- ë“œë¡­ë‹¤ìš´ (ë°©ì–´íŒ€ ì„ íƒ) --- */
  .dropdown-wrapper { position: relative; margin-bottom: 25px; z-index: 100; }
  
  .glass-box {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 18px;
    backdrop-filter: var(--glass-blur);
    box-shadow: var(--glass-shadow);
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; transition: 0.3s;
  }
  .glass-box:hover {
    background: rgba(255, 255, 255, 0.07);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; width: 100%;
    background: #0f0f0f; border: 1px solid #333; border-radius: 12px;
    margin-top: 8px; max-height: 350px; overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.9);
  }
  .dropdown-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }
  .dropdown-item:hover { background: #222; color: var(--accent); }

  /* --- ê³µê²©íŒ€ ë¦¬ìŠ¤íŠ¸ (ê·¸ë¦¬ë“œ) --- */
  #attackList {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .attack-btn {
    background: var(--glass-bg); border: 1px solid #333;
    color: #ccc; padding: 15px 5px; border-radius: 10px;
    min-height: 80px; text-align: center;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .attack-btn.active {
    background: rgba(79, 172, 254, 0.1);
    border: 1px solid var(--accent);
    color: #fff; box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
  }

  /* --- ìƒì„¸ ì •ë³´ ì¹´ë“œ --- */
  #attackCard {
    background: rgba(20, 20, 20, 0.9); border: 1px solid #444;
    border-radius: 12px; padding: 20px; display: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.7);
  }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
  .info-item { background: #222; padding: 10px; border-radius: 6px; font-size: 0.9rem; }
  .info-label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 4px; }

  /* ìŠ¹íŒ¨ ë²„íŠ¼ */
  .btn-win { background: #198754; color: #fff; width: 48%; padding: 15px; }
  .btn-lose { background: #dc3545; color: #fff; width: 48%; padding: 15px; }

  /* --- ë­í‚¹ ë¦¬ìŠ¤íŠ¸ --- */
  .rank-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px; border-bottom: 1px solid #222; font-size: 0.95rem;
  }
  .rank-row:last-child { border-bottom: none; }
  
  /* ë©”ë‹¬ ìƒ‰ìƒ */
  .rank-gold { color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
  .rank-silver { color: #C0C0C0; text-shadow: 0 0 10px rgba(192, 192, 192, 0.3); }
  .rank-bronze { color: #CD7F32; text-shadow: 0 0 10px rgba(205, 127, 50, 0.3); }

  /* --- ê´€ë¦¬ì íŒ¨ë„ --- */
  #adminPanel {
    background: #151515; border: 1px solid #444;
    padding: 20px; border-radius: 12px; margin-top: 30px; display: none;
  }
  
  /* ìœ ì € ê´€ë¦¬ ë²„íŠ¼ (ì‘ì€ ì‚¬ì´ì¦ˆ) */
  .mini-btn { padding: 4px 8px; font-size: 0.8rem; margin-left: 2px; }
  .bg-blue { background: #0d6efd; color: #fff; }
  .bg-red { background: #dc3545; color: #fff; }
  
  footer {
    text-align: center; margin-top: 50px; padding: 20px;
    color: #555; font-size: 0.8rem; border-top: 1px solid #111;
  }
</style>
</head>
<body>

<div id="loginScreen" style="text-align:center; margin-top:100px;">
  <h2 style="font-size:2rem; margin-bottom:30px;">ğŸ”¥ í™”ë‘ ê¸¸ë“œì „</h2>
  <div style="background:#111; padding:30px; border-radius:15px; display:inline-block; border:1px solid #333;">
    <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="text-align:center; margin-bottom:15px;"><br>
    <button onclick="enterSite()" style="width:100%; background:var(--accent); color:#000;">ì…ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="mainScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <span id="currentNick" style="color:var(--accent); font-weight:bold;"></span>
    <button onclick="toggleAdmin()" id="adminBtn" style="background:#333; color:#fff; font-size:0.8rem;">+ ê´€ë¦¬ì</button>
  </div>

  <div class="dropdown-wrapper">
    <div style="color:#888; font-size:0.8rem; margin-bottom:5px; margin-left:5px;">ğŸ›¡ï¸ ë°©ì–´íŒ€ ì„ íƒ</div>
    <div class="glass-box" onclick="toggleDropdown()">
      <span id="defCurrentText" style="font-weight:bold;">ë°©ì–´íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
      <span style="color:#666;">â–¼</span>
    </div>
    <div id="defListDropdown" class="dropdown-list"></div>
  </div>

  <div id="attackList"></div>

  <div id="attackCard">
    <h2 style="border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">
      <span id="cardFire"></span> <span id="cardName"></span>
      <span style="float:right; font-size:0.6em; color:#888; font-weight:normal;">
        ìŠ¹ë¥  <span id="cardRate" style="color:#fff; font-size:1.4em; font-weight:bold;">0</span>%
      </span>
    </h2>

    <div class="info-grid">
      <div class="info-item"><span class="info-label">ì „ì </span><span id="cardWin">0</span>ìŠ¹ <span id="cardLose">0</span>íŒ¨</div>
      <div class="info-item"><span class="info-label">íƒ€ì…</span><span id="cardType">-</span></div>
      <div class="info-item"><span class="info-label">ì§„í˜•/í«</span><span id="cardRing">-</span></div>
      <div class="info-item"><span class="info-label">ìŠ¤í‚¬ìˆœì„œ</span><span id="cardSkill">-</span></div>
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">ì˜ì›…/ì¥ë¹„/íŠ¹ì´ì‚¬í•­</span><span id="cardArmor">-</span>
      </div>
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">ìµœê·¼ 5ê²½ê¸°</span>
        <div id="recentRecord" style="font-size:1.2rem; letter-spacing:3px;">-</div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button class="btn-win" onclick="addWin()">ğŸ† ìŠ¹ë¦¬</button>
      <button class="btn-lose" onclick="addLose()">ğŸ’€ íŒ¨ë°°</button>
    </div>
    <div style="text-align:right; margin-top:10px;">
       <button onclick="resetRecord()" style="background:transparent; color:#666; font-size:0.8rem; text-decoration:underline;">[ê´€ë¦¬ì] ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div style="margin-top:40px; border-top:1px solid #333; padding-top:20px;">
    <h3 style="color:#aaa; font-size:1rem;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (ìŠ¹ë¦¬ ë­í‚¹)</h3>
    <div id="rankingList" style="background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid #333;"></div>
    <div id="moreRankMsg" style="text-align:center; color:#555; font-size:0.8rem; margin-top:10px; display:none;">
      * 11ìœ„ ì´í•˜ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.
    </div>
  </div>

  <div id="adminPanel">
    <h3>ğŸ› ï¸ ë°ì´í„° ê´€ë¦¬</h3>
    
    <div style="margin-bottom:20px;">
      <h4>ë°©ì–´íŒ€ ê´€ë¦¬</h4>
      <input type="text" id="defName" placeholder="ìƒˆ ë°©ì–´íŒ€ ì´ë¦„">
      <button onclick="addDefense()" style="background:#444; color:#fff;">ì¶”ê°€</button>
      <button onclick="delDefense()" style="background:#700; color:#fff;">í˜„ì¬ ë°©ì–´íŒ€ ì‚­ì œ</button>
    </div>
    
    <div style="margin-bottom:20px;">
      <h4>ê³µê²©íŒ€(ë±) ê´€ë¦¬</h4>
      <input type="text" id="atkName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
      <input type="text" id="atkType" placeholder="íƒ€ì…">
      <input type="text" id="ringRec" placeholder="ì§„í˜•/í«">
      <textarea id="armorRec" rows="2" placeholder="íŠ¹ì´ì‚¬í•­"></textarea>
      <input type="text" id="skillOrder" placeholder="ìŠ¤í‚¬ ìˆœì„œ">
      <div style="margin-top:5px;">
        <button onclick="addAttack()" style="background:#444; color:#fff;">ì¶”ê°€</button>
        <button onclick="editAttack()" style="background:#0d6efd; color:#fff;">ìˆ˜ì • ì €ì¥</button>
        <button onclick="delAttack()" style="background:#700; color:#fff;">ì‚­ì œ</button>
      </div>
    </div>

    <hr style="border-color:#444; margin:20px 0;">
    
    <h4>ğŸ‘¥ ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)</h4>
    <div id="adminUserList" style="max-height:300px; overflow-y:auto; background:#111; padding:10px; border-radius:8px;">
      </div>
  </div>

  <footer>
    <div style="margin-bottom:5px;">Designed & Developed by <b>í™”ë‘</b></div>
    <div style="font-size:0.7rem; color:#444;">Copyright Â© 2024 Hwarang Guild. All rights reserved.</div>
  </footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "1513";

let myNick = "";
let currentDefense = "";
let currentAttack = "";
let adminOpen = false;
let allLogsCache = []; // ë¡œê·¸ ë°ì´í„° ì €ì¥ìš©

window.onload = () => {
  myNick = localStorage.getItem("nickname");
  if (!myNick) {
    document.getElementById("loginScreen").style.display = "block";
    document.getElementById("mainScreen").style.display = "none";
  } else {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainScreen").style.display = "block";
    document.getElementById("currentNick").textContent = `ì‚¬ë ¹ê´€ : ${myNick}`;
  }
};

window.enterSite = () => {
  const n = document.getElementById("nickInput").value.trim();
  if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
  myNick = n;
  localStorage.setItem("nickname", myNick);
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainScreen").style.display = "block";
  document.getElementById("currentNick").textContent = `ì‚¬ë ¹ê´€ : ${myNick}`; 
};

function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if(pw !== ADMIN_PW) { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return false; }
  return true;
}

window.toggleAdmin = () => {
  const panel = document.getElementById("adminPanel");
  const btn = document.getElementById("adminBtn");
  if(!adminOpen){
    if(!checkPW()) return;
    panel.style.display="block";
    btn.textContent="âˆ’ ê´€ë¦¬ì ë‹«ê¸°";
    adminOpen=true;
  }else{
    panel.style.display="none";
    btn.textContent="+ ê´€ë¦¬ì";
    adminOpen=false;
  }
  // ê´€ë¦¬ì ëª¨ë“œ ì „í™˜ ì‹œ ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ìˆ¨ê²¨ì§„ ìˆœìœ„ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬)
  renderRanking();
  renderAdminUserList(); // ìœ ì € ìˆ˜ì • ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
};

/* ë“œë¡­ë‹¤ìš´ ì œì–´ */
window.toggleDropdown = () => {
  const list = document.getElementById("defListDropdown");
  list.style.display = (list.style.display === "block") ? "none" : "block";
};
window.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown-wrapper')) {
    document.getElementById("defListDropdown").style.display = "none";
  }
});

/* ë°©ì–´íŒ€ ëª©ë¡ */
onValue(ref(db,"defenseTeams"), snap => {
  const listDiv = document.getElementById("defListDropdown");
  listDiv.innerHTML = "";
  const d = snap.val();
  if(!d) {
    document.getElementById("defCurrentText").textContent = "ë°ì´í„° ì—†ìŒ"; return;
  }
  Object.entries(d).forEach(([k, v]) => {
    const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
    const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
    const rate = (tWins+tLose) ? Math.round(tWins/(tWins+tLose)*100) : 0;
    
    const div = document.createElement("div");
    div.className = "dropdown-item";
    div.innerHTML = `<b>${v.name}</b><small>ë°©ì–´ ì„±ê³µë¥  ${rate}% (${tWins}ìŠ¹ ${tLose}íŒ¨)</small>`;
    div.onclick = () => {
      document.getElementById("defCurrentText").innerHTML = `${v.name} <span style="font-size:0.8em; color:#888;">(${rate}%)</span>`;
      document.getElementById("defListDropdown").style.display = "none";
      loadAttackTeams(k);
    };
    listDiv.appendChild(div);
  });
});

window.loadAttackTeams = (dk) => {
  currentDefense = dk;
  currentAttack = ""; 
  document.getElementById("attackCard").style.display = "none";
  const attackList = document.getElementById("attackList");
  attackList.innerHTML="";

  onValue(ref(db,`defenseTeams/${dk}/attackTeams`), snap => {
    attackList.innerHTML="";
    const d = snap.val(); if(!d) return;
    
    Object.entries(d).forEach(([ak, av]) => {
      const t = av.win + av.lose;
      const r = t ? Math.round(av.win/t*100) : 0;
      
      const b = document.createElement("button");
      b.className = "attack-btn";
      const fire = r >= 70 ? "<span style='color:red'>ğŸ”¥</span> " : "";
      b.innerHTML = `<b>${fire}${av.name}</b><small>${r}% (${av.win}ìŠ¹ ${av.lose}íŒ¨)</small>`;
      b.onclick = () => {
        document.querySelectorAll(".attack-btn").forEach(btn => btn.classList.remove("active"));
        b.classList.add("active");
        selectAttack(dk, ak);
      };
      attackList.appendChild(b);
    });
  });
};

/* ìƒì„¸ ì •ë³´ ë° ì „ì  */
async function loadRecentRecord(defenseKey, attackKey){
  const snap = await get(ref(db,"logs"));
  const recordDiv = document.getElementById("recentRecord");
  if(!snap.exists()) { recordDiv.innerHTML = "-"; return; }
  
  const logs = Object.values(snap.val())
    .filter(v => v.defense === defenseKey && v.attack === attackKey)
    .sort((a,b)=>b.time-a.time).slice(0,5);
  let html = "";
  logs.forEach(v => { html += (v.result === "win" ? "<span style='color:#4caf50;'>W</span> " : "<span style='color:#f44336;'>L</span> "); });
  recordDiv.innerHTML = html || "-";
}

window.selectAttack = (dk, ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap => {
    const d = snap.val(); if(!d) return;
    document.getElementById("attackCard").style.display = "block";
    document.getElementById("cardName").textContent = d.name;
    document.getElementById("cardWin").textContent = d.win;
    document.getElementById("cardLose").textContent = d.lose;
    
    const total = d.win + d.lose;
    const rateVal = total ? Math.round(d.win / total * 100) : 0;
    document.getElementById("cardRate").textContent = rateVal;
    document.getElementById("cardFire").textContent = rateVal >= 70 ? "ğŸ”¥" : "";
    document.getElementById("cardType").textContent = d.type || "-";
    document.getElementById("cardRing").textContent = d.ring || "-";
    document.getElementById("cardArmor").innerHTML = (d.armor || "-").replace(/\n/g,"<br>");
    document.getElementById("cardSkill").textContent = d.skill || "-";
    loadRecentRecord(dk, ak);

    document.getElementById("atkName").value=d.name; 
    document.getElementById("atkType").value=d.type; 
    document.getElementById("ringRec").value=d.ring; 
    document.getElementById("armorRec").value=d.armor; 
    document.getElementById("skillOrder").value=d.skill;
  });
};

async function canInput(){
  const today = new Date().toISOString().slice(0,10);
  const snap = await get(ref(db,"logs"));
  let cnt = 0;
  if(snap.exists()){
    Object.values(snap.val()).forEach(v=>{ if(v.nick===myNick && v.date===today) cnt++; });
  }
  return cnt < 5;
}

async function writeLog(result){
  if(!currentDefense || !currentAttack) return alert("âš ï¸ íŒ€ ì„ íƒ ì˜¤ë¥˜");
  const snap = await get(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`));
  if(!snap.exists()) { loadAttackTeams(currentDefense); return; }
  const atk = snap.val();
  set(push(ref(db,"logs")),{
    nick: myNick, result, defense: currentDefense, attack: currentAttack,
    attackName: atk.name || "", attackType: atk.type || "",
    date: new Date().toISOString().slice(0,10), time: Date.now()
  });
}

window.addWin = async () => {
  if(!currentDefense || !currentAttack) return alert("âš ï¸ ì„ íƒ í•„ìš”");
  if (!await canInput()) return alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ");
  if (!confirm(`ìŠ¹ë¦¬ ê¸°ë¡?`)) return;
  const w = +document.getElementById("cardWin").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { win: w + 1 });
  writeLog("win");
};

window.addLose = async () => {
  if(!currentDefense || !currentAttack) return alert("âš ï¸ ì„ íƒ í•„ìš”");
  if (!await canInput()) return alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ");
  if (!confirm(`íŒ¨ë°° ê¸°ë¡?`)) return;
  const l = +document.getElementById("cardLose").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { lose: l + 1 });
  writeLog("lose");
};

/* ê´€ë¦¬ì: CRUD ë° ë¦¬ì…‹ */
window.resetRecord = () => {
  if(!checkPW()) return;
  if(!currentAttack) return alert("ê³µê²©íŒ€ ì„ íƒ í•„ìš”");
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};
window.addDefense = ()=>{ if(checkPW()) set(push(ref(db,"defenseTeams")),{name:document.getElementById("defName").value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };
window.addAttack = ()=>{
  if(!checkPW()) return;
  set(push(ref(db,`defenseTeams/${currentDefense}/attackTeams`)),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, armor:document.getElementById("armorRec").value, 
    skill:document.getElementById("skillOrder").value, win:0, lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW() || !currentAttack) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, armor:document.getElementById("armorRec").value, 
    skill:document.getElementById("skillOrder").value
  });
  alert("ìˆ˜ì •ì™„ë£Œ");
};
window.delAttack = ()=>{ if(checkPW() && currentAttack) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

/* --- ë­í‚¹ ë° ìœ ì € ê´€ë¦¬ ë¡œì§ --- */
onValue(ref(db,"logs"), snap => {
  allLogsCache = snap.val() || {}; // ë¡œê·¸ ìºì‹±
  renderRanking();
  if(adminOpen) renderAdminUserList();
});

// ë­í‚¹ ë Œë”ë§ (adminOpenì— ë”°ë¼ 10ìœ„ ì œí•œ)
function renderRanking() {
  const rankingList = document.getElementById("rankingList");
  const msg = document.getElementById("moreRankMsg");
  rankingList.innerHTML = "";
  
  if(!Object.keys(allLogsCache).length) {
    rankingList.innerHTML = "<div style='text-align:center; padding:10px; color:#555;'>ê¸°ë¡ ì—†ìŒ</div>";
    return;
  }
  
  const stat = {};
  Object.values(allLogsCache).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0, l:0, total:0};
    stat[v.nick].total++;
    if(v.result === "win") stat[v.nick].w++;
    else stat[v.nick].l++;
  });
  
  // ìŠ¹ë¦¬(Win) ìˆœìœ¼ë¡œ ì •ë ¬
  const sorted = Object.entries(stat).sort((a,b) => b[1].w - a[1].w);
  
  let hiddenCount = 0;

  sorted.forEach(([nick, val], index) => {
    // ê´€ë¦¬ìê°€ ì•„ë‹ˆê³  10ë“± ë°–ì´ë©´ ìˆ¨ê¹€
    if(!adminOpen && index >= 10) {
      hiddenCount++;
      return;
    }

    let badge = "";
    let nickStyle = "color:#fff; font-weight:bold;";
    
    if(index === 0) { badge = "ğŸ¥‡"; nickStyle = "color:#FFD700; font-weight:bold;"; }
    else if(index === 1) { badge = "ğŸ¥ˆ"; nickStyle = "color:#C0C0C0; font-weight:bold;"; }
    else if(index === 2) { badge = "ğŸ¥‰"; nickStyle = "color:#CD7F32; font-weight:bold;"; }
    else { badge = `<span style='width:20px; display:inline-block; text-align:center; color:#666;'>${index+1}</span>`; }

    const div = document.createElement("div");
    div.className = "rank-row";
    // ê´€ë¦¬ìì¼ ê²½ìš° êµ¬ë¶„ì„ ìœ„í•´ ë°°ê²½ìƒ‰ ì‚´ì§ ë‹¤ë¥´ê²Œ
    if(adminOpen && index >= 10) div.style.background = "rgba(255,0,0,0.05)";

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        ${badge} <span style="${nickStyle}">${nick}</span>
      </div>
      <span style="color:#888; font-size:0.85rem;">
        <span style="color:${val.w>0?'#4caf50':'#666'}">${val.w}ìŠ¹</span> / ${val.l}íŒ¨
      </span>
    `;
    rankingList.appendChild(div);
  });

  if(hiddenCount > 0) msg.style.display = "block";
  else msg.style.display = "none";
}

/* ê´€ë¦¬ì: ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì • ê¸°ëŠ¥ */
window.adjustScore = async (nick, type, delta) => {
  if(!checkPW()) return;
  
  if(delta === 1) {
    // ì¶”ê°€ (+): ê°€ì§œ ë¡œê·¸ ì¶”ê°€
    set(push(ref(db,"logs")),{
      nick: nick, result: type, defense: "admin", attack: "manual_adjust",
      attackName: "ê´€ë¦¬ììˆ˜ì •", attackType: "",
      date: new Date().toISOString().slice(0,10), time: Date.now()
    });
  } else {
    // ê°ì†Œ (-): í•´ë‹¹ ìœ ì €ì˜ ê°€ì¥ ìµœê·¼ í•´ë‹¹ ê²°ê³¼ ë¡œê·¸ 1ê°œ ì‚­ì œ
    // ìºì‹œëœ ë¡œê·¸ ì‚¬ìš©í•˜ë©´ ê¼¬ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì‹¤ì‹œê°„ ì¡°íšŒ
    const snap = await get(ref(db, "logs"));
    if(!snap.exists()) return alert("ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
    
    const logs = Object.entries(snap.val())
      .map(([k,v]) => ({...v, key:k}))
      .filter(v => v.nick === nick && v.result === type)
      .sort((a,b) => b.time - a.time); // ìµœì‹ ìˆœ ì •ë ¬
      
    if(logs.length === 0) return alert("ì°¨ê°í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
    
    // ê°€ì¥ ìµœê·¼ ê¸°ë¡ ì‚­ì œ
    await remove(ref(db, `logs/${logs[0].key}`));
  }
  alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

/* ê´€ë¦¬ì íŒ¨ë„ìš© ìœ ì € ë¦¬ìŠ¤íŠ¸ ìƒì„± */
function renderAdminUserList() {
  const listDiv = document.getElementById("adminUserList");
  listDiv.innerHTML = "";
  
  const stat = {};
  Object.values(allLogsCache).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0, l:0};
    if(v.result === "win") stat[v.nick].w++;
    else stat[v.nick].l++;
  });

  // ì´ë¦„ìˆœ ì •ë ¬
  const sorted = Object.keys(stat).sort();
  
  sorted.forEach(nick => {
    const val = stat[nick];
    const div = document.createElement("div");
    div.style.padding = "10px";
    div.style.borderBottom = "1px solid #333";
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    
    div.innerHTML = `
      <span style="font-weight:bold; width:80px;">${nick}</span>
      <div style="display:flex; align-items:center; gap:5px;">
        <span style="color:#4caf50; font-size:0.8rem;">ìŠ¹:${val.w}</span>
        <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','win',1)">+</button>
        <button class="mini-btn bg-red" onclick="adjustScore('${nick}','win',-1)">-</button>
        <span style="color:#dc3545; font-size:0.8rem; margin-left:5px;">íŒ¨:${val.l}</span>
        <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','lose',1)">+</button>
        <button class="mini-btn bg-red" onclick="adjustScore('${nick}','lose',-1)">-</button>
      </div>
    `;
    listDiv.appendChild(div);
  });
}

</script>
</body>
</html>
