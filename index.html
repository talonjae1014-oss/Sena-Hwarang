<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ (Final + ì œë³´ê¸°ëŠ¥)</title>
<style>
  /* --- [ìŠ¤íƒ€ì¼] Glassmorphism & Dark UI --- */
  :root {
    --bg-color: #050505;
    --text-main: #f0f0f0;
    --text-sub: #a0a0a0;
    --accent: #4facfe;
    
    --glass-bg: rgba(255, 255, 255, 0.03);
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    --glass-blur: blur(10px);
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-main);
    font-family: 'Suit', sans-serif;
    margin: 0; padding: 20px; padding-bottom: 100px;
  }

  h2, h3, h4 { margin-top: 0; color: #fff; font-weight: 700; }
  
  button {
    cursor: pointer; border: none; padding: 10px 15px; border-radius: 8px;
    font-weight: bold; transition: 0.2s;
  }
  input, select, textarea {
    background: rgba(30, 30, 30, 0.8);
    border: 1px solid #444; color: #fff;
    padding: 12px; border-radius: 8px; width: 100%;
    box-sizing: border-box; margin-bottom: 8px;
  }

  /* ë“œë¡­ë‹¤ìš´ */
  .dropdown-wrapper { position: relative; margin-bottom: 25px; z-index: 100; }
  .glass-box {
    background: var(--glass-bg); border: 1px solid var(--glass-border);
    border-radius: 12px; padding: 18px;
    backdrop-filter: var(--glass-blur); box-shadow: var(--glass-shadow);
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; transition: 0.3s;
  }
  .glass-box:hover { background: rgba(255, 255, 255, 0.07); border-color: rgba(255, 255, 255, 0.3); }
  .dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; width: 100%;
    background: #0f0f0f; border: 1px solid #333; border-radius: 12px;
    margin-top: 8px; max-height: 350px; overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.9);
  }
  .dropdown-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }
  .dropdown-item:hover { background: #222; color: var(--accent); }

  /* ê³µê²©íŒ€ ë¦¬ìŠ¤íŠ¸ */
  #attackList {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .attack-btn {
    background: var(--glass-bg); border: 1px solid #333;
    color: #ccc; padding: 15px 5px; border-radius: 10px;
    min-height: 80px; text-align: center;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .attack-btn.active {
    background: rgba(79, 172, 254, 0.1); border: 1px solid var(--accent);
    color: #fff; box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
  }

  /* ìƒì„¸ ì •ë³´ ì¹´ë“œ */
  #attackCard {
    background: rgba(20, 20, 20, 0.9); border: 1px solid #444;
    border-radius: 12px; padding: 20px; display: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.7);
  }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
  .info-item { background: #222; padding: 10px; border-radius: 6px; font-size: 0.9rem; }
  .info-label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 4px; }
  .btn-win { background: #198754; color: #fff; width: 48%; padding: 15px; }
  .btn-lose { background: #dc3545; color: #fff; width: 48%; padding: 15px; }

  /* ë­í‚¹ ë¦¬ìŠ¤íŠ¸ */
  .rank-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px; border-bottom: 1px solid #222; font-size: 0.95rem;
  }
  
  /* ê´€ë¦¬ì íŒ¨ë„ */
  #adminPanel {
    background: #151515; border: 1px solid #444;
    padding: 20px; border-radius: 12px; margin-top: 30px; display: none;
  }
  .mini-btn { padding: 4px 8px; font-size: 0.8rem; margin-left: 2px; }
  .bg-blue { background: #0d6efd; color: #fff; }
  .bg-red { background: #dc3545; color: #fff; }

  /* ì œë³´ ëª¨ë‹¬ (Modal) ì¶”ê°€ë¨ */
  #suggestModal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 2000;
    align-items: center; justify-content: center;
  }
  .modal-content {
    background: #1a1a1a; padding: 20px; border-radius: 12px;
    width: 90%; max-width: 400px; border: 1px solid #444;
  }

  /* ì œë³´ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
  .suggest-item {
    background: #222; padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #333;
  }

  footer {
    text-align: center; margin-top: 50px; padding: 20px;
    color: #555; font-size: 0.8rem; border-top: 1px solid #111;
  }
</style>
</head>
<body>

<div id="loginScreen" style="text-align:center; margin-top:100px;">
  <h2 style="font-size:2rem; margin-bottom:30px;">ğŸ”¥ í™”ë‘ ê¸¸ë“œì „</h2>
  <div style="background:#111; padding:30px; border-radius:15px; display:inline-block; border:1px solid #333;">
    <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="text-align:center; margin-bottom:15px;"><br>
    <button onclick="enterSite()" style="width:100%; background:var(--accent); color:#000;">ì…ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="mainScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  
  <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
    <div>
      <div id="currentNick" style="color:var(--accent); font-weight:bold; font-size:1.1rem; margin-bottom:4px;"></div>
      <div id="myStats" style="color:#aaa; font-size:0.85rem;">ë‚´ ì „ì  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <button onclick="toggleAdmin()" id="adminBtn" style="background:#333; color:#fff; font-size:0.8rem; padding:6px 12px;">+ ê´€ë¦¬ì</button>
  </div>

  <div class="dropdown-wrapper">
    <div style="color:#888; font-size:0.8rem; margin-bottom:5px; margin-left:5px;">ğŸ›¡ï¸ ë°©ì–´íŒ€ ì„ íƒ</div>
    <div class="glass-box" onclick="toggleDropdown()">
      <span id="defCurrentText" style="font-weight:bold;">ë°©ì–´íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
      <span style="color:#666;">â–¼</span>
    </div>
    <div id="defListDropdown" class="dropdown-list"></div>
  </div>

  <div id="attackList"></div>

  <div id="suggestBtnArea" style="text-align:center; margin-bottom:20px; display:none;">
    <button onclick="openSuggestModal()" style="background:transparent; border:1px dashed #555; color:#888; width:100%;">
      + ê³µê²©ë± ì œë³´í•˜ê¸° (ìœ ì € ì°¸ì—¬)
    </button>
  </div>

  <div id="attackCard">
    <h2 style="border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px;">
      <span id="cardFire"></span> <span id="cardName"></span>
      <span style="float:right; font-size:0.6em; color:#888; font-weight:normal;">
        ìŠ¹ë¥  <span id="cardRate" style="color:#fff; font-size:1.4em; font-weight:bold;">0</span>%
      </span>
      <div id="cardMaker" style="font-size:0.4em; color:var(--accent); font-weight:normal; margin-top:5px;"></div>
    </h2>

    <div class="info-grid">
      <div class="info-item"><span class="info-label">ì „ì </span><span id="cardWin">0</span>ìŠ¹ <span id="cardLose">0</span>íŒ¨</div>
      <div class="info-item"><span class="info-label">íƒ€ì…</span><span id="cardType">-</span></div>
      <div class="info-item"><span class="info-label">ì§„í˜•/í«</span><span id="cardRing">-</span></div>
      <div class="info-item"><span class="info-label">ìŠ¤í‚¬ìˆœì„œ</span><span id="cardSkill">-</span></div>
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">ì˜ì›…/ì¥ë¹„/íŠ¹ì´ì‚¬í•­</span><span id="cardArmor">-</span>
      </div>
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">ìµœê·¼ 5ê²½ê¸°</span>
        <div id="recentRecord" style="font-size:1.2rem; letter-spacing:3px;">-</div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button class="btn-win" onclick="addWin()">ğŸ† ìŠ¹ë¦¬</button>
      <button class="btn-lose" onclick="addLose()">ğŸ’€ íŒ¨ë°°</button>
    </div>
    <div style="text-align:right; margin-top:10px;">
       <button onclick="resetRecord()" style="background:transparent; color:#666; font-size:0.8rem; text-decoration:underline;">[ê´€ë¦¬ì] ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div style="margin-top:40px; border-top:1px solid #333; padding-top:20px;">
    <h3 style="color:#aaa; font-size:1rem;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (ìŠ¹ë¦¬ ë­í‚¹)</h3>
    <div id="rankingList" style="background:rgba(255,255,255,0.03); border-radius:12px; border:1px solid #333;"></div>
    <div id="moreRankMsg" style="text-align:center; color:#555; font-size:0.8rem; margin-top:10px; display:none;">
      * 11ìœ„ ì´í•˜ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.
    </div>
  </div>

  <div id="adminPanel">
    <h3>ğŸ› ï¸ ë°ì´í„° ê´€ë¦¬</h3>
    
    <div style="background:#221a1a; padding:10px; border-radius:8px; border:1px solid #633; margin-bottom:20px;">
      <h4 style="color:#ffaaaa;">ğŸ”” ëŒ€ê¸° ì¤‘ì¸ ì œë³´</h4>
      <div id="suggestionList" style="color:#888; font-size:0.9rem;">(ì œë³´ëœ ë±ì´ ì—†ìŠµë‹ˆë‹¤)</div>
    </div>

    <div style="margin-bottom:20px;">
      <h4>ë°©ì–´íŒ€ ê´€ë¦¬</h4>
      <input type="text" id="defName" placeholder="ìƒˆ ë°©ì–´íŒ€ ì´ë¦„">
      <button onclick="addDefense()" style="background:#444; color:#fff;">ì¶”ê°€</button>
      <button onclick="delDefense()" style="background:#700; color:#fff;">í˜„ì¬ ë°©ì–´íŒ€ ì‚­ì œ</button>
    </div>
    
    <div style="margin-bottom:20px;">
      <h4>ê³µê²©íŒ€(ë±) ê´€ë¦¬</h4>
      <input type="text" id="atkName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
      <input type="text" id="atkType" placeholder="íƒ€ì…">
      <input type="text" id="ringRec" placeholder="ì§„í˜•/í«">
      <textarea id="armorRec" rows="2" placeholder="íŠ¹ì´ì‚¬í•­"></textarea>
      <input type="text" id="skillOrder" placeholder="ìŠ¤í‚¬ ìˆœì„œ">
      <div style="margin-top:5px;">
        <button onclick="addAttack()" style="background:#444; color:#fff;">ì¶”ê°€</button>
        <button onclick="editAttack()" style="background:#0d6efd; color:#fff;">ìˆ˜ì • ì €ì¥</button>
        <button onclick="delAttack()" style="background:#700; color:#fff;">ì‚­ì œ</button>
      </div>
    </div>

    <hr style="border-color:#444; margin:20px 0;">
    
    <h4>ğŸ‘¥ ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)</h4>
    <div id="adminUserList" style="max-height:300px; overflow-y:auto; background:#111; padding:10px; border-radius:8px;">
      </div>
  </div>

  <footer>
    <div style="margin-bottom:5px;">Designed & Developed by <b>í™”ë‘</b></div>
    <div style="font-size:0.7rem; color:#444;">Copyright Â© 2024 Hwarang Guild. All rights reserved.</div>
  </footer>
</div>

<div id="suggestModal">
  <div class="modal-content">
    <h3>ğŸ’¡ ê³µê²©ë± ì œë³´</h3>
    <p style="color:#aaa; font-size:0.8rem; margin-bottom:15px;">ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë©ë‹ˆë‹¤.</p>
    <input type="text" id="sugName" placeholder="ê³µê²©íŒ€ ì´ë¦„ (í•„ìˆ˜)">
    <input type="text" id="sugType" placeholder="íƒ€ì… (ë§ŒëŠ¥í˜• ë“±)">
    <input type="text" id="sugRing" placeholder="ì§„í˜•/í«">
    <textarea id="sugArmor" rows="2" placeholder="ì˜ì›…/ì¥ë¹„/íŠ¹ì´ì‚¬í•­"></textarea>
    <input type="text" id="sugSkill" placeholder="ìŠ¤í‚¬ ìˆœì„œ">
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="submitSuggestion()" style="flex:1; background:var(--accent); color:#000;">ì œë³´í•˜ê¸°</button>
      <button onclick="closeSuggestModal()" style="flex:1; background:#333; color:#fff;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "1513";

let myNick = "";
let currentDefense = "";
let currentAttack = "";
let adminOpen = false;
let allLogsCache = []; 
let defenseDataCache = {}; // ë°©ì–´íŒ€ ë°ì´í„° ìºì‹œ ì¶”ê°€

window.onload = () => {
  myNick = localStorage.getItem("nickname");
  if (!myNick) {
    document.getElementById("loginScreen").style.display = "block";
    document.getElementById("mainScreen").style.display = "none";
  } else {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainScreen").style.display = "block";
    document.getElementById("currentNick").textContent = `ë‹‰ë„¤ì„ : ${myNick}`;
  }
};

window.enterSite = () => {
  const n = document.getElementById("nickInput").value.trim();
  if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
  myNick = n;
  localStorage.setItem("nickname", myNick);
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainScreen").style.display = "block";
  document.getElementById("currentNick").textContent = `ë‹‰ë„¤ì„ : ${myNick}`;
};

function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if(pw !== ADMIN_PW) { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return false; }
  return true;
}

window.toggleAdmin = () => {
  const panel = document.getElementById("adminPanel");
  const btn = document.getElementById("adminBtn");
  if(!adminOpen){
    if(!checkPW()) return;
    panel.style.display="block";
    btn.textContent="âˆ’ ê´€ë¦¬ì ë‹«ê¸°";
    adminOpen=true;
  }else{
    panel.style.display="none";
    btn.textContent="+ ê´€ë¦¬ì";
    adminOpen=false;
  }
  renderRanking();
  renderAdminUserList(); 
  renderSuggestions(); // ê´€ë¦¬ì ì—´ ë•Œ ì œë³´ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
};

window.toggleDropdown = () => {
  const list = document.getElementById("defListDropdown");
  list.style.display = (list.style.display === "block") ? "none" : "block";
};
window.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown-wrapper')) {
    document.getElementById("defListDropdown").style.display = "none";
  }
});

/* ë°©ì–´íŒ€ ëª©ë¡ (ë“œë¡­ë‹¤ìš´) */
onValue(ref(db,"defenseTeams"), snap => {
  const listDiv = document.getElementById("defListDropdown");
  listDiv.innerHTML = "";
  defenseDataCache = snap.val() || {}; // ë°ì´í„° ìºì‹±
  
  if(!defenseDataCache) {
    document.getElementById("defCurrentText").textContent = "ë°ì´í„° ì—†ìŒ"; return;
  }
  Object.entries(defenseDataCache).forEach(([k, v]) => {
    const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
    const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
    const rate = (tWins+tLose) ? Math.round(tWins/(tWins+tLose)*100) : 0;
    
    const div = document.createElement("div");
    div.className = "dropdown-item";
    div.innerHTML = `<b>${v.name}</b><small>ê³µê²© ì„±ê³µë¥  ${rate}% (${tWins}ìŠ¹ ${tLose}íŒ¨)</small>`;
    div.onclick = () => {
      document.getElementById("defCurrentText").innerHTML = `${v.name} <span style="font-size:0.8em; color:#888;">(${rate}%)</span>`;
      document.getElementById("defListDropdown").style.display = "none";
      loadAttackTeams(k);
    };
    listDiv.appendChild(div);
  });
});

window.loadAttackTeams = (dk) => {
  currentDefense = dk;
  currentAttack = ""; 
  document.getElementById("attackCard").style.display = "none";
  // [ì¶”ê°€ë¨] ë°©ì–´íŒ€ ì„ íƒ ì‹œ ì œë³´ ë²„íŠ¼ í‘œì‹œ
  document.getElementById("suggestBtnArea").style.display = "block";
  
  const attackList = document.getElementById("attackList");
  attackList.innerHTML="";

  onValue(ref(db,`defenseTeams/${dk}/attackTeams`), snap => {
    attackList.innerHTML="";
    const d = snap.val(); if(!d) return;
    
    Object.entries(d).forEach(([ak, av]) => {
      const t = av.win + av.lose;
      const r = t ? Math.round(av.win/t*100) : 0;
      
      const b = document.createElement("button");
      b.className = "attack-btn";
      const fire = r >= 70 ? "<span style='color:red'>ğŸ”¥</span> " : "";
      b.innerHTML = `<b>${fire}${av.name}</b><small>${r}% (${av.win}ìŠ¹ ${av.lose}íŒ¨)</small>`;
      b.onclick = () => {
        document.querySelectorAll(".attack-btn").forEach(btn => btn.classList.remove("active"));
        b.classList.add("active");
        selectAttack(dk, ak);
      };
      attackList.appendChild(b);
    });
  });
  renderSuggestions(); // ê°±ì‹ 
};

/* [ì¶”ê°€ë¨] ì œë³´ ê´€ë ¨ í•¨ìˆ˜ë“¤ */
window.openSuggestModal = () => { document.getElementById("suggestModal").style.display = "flex"; };
window.closeSuggestModal = () => { document.getElementById("suggestModal").style.display = "none"; };

window.submitSuggestion = () => {
  if(!currentDefense) return alert("ë°©ì–´íŒ€ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  const name = document.getElementById("sugName").value;
  if(!name) return alert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

  const data = {
    name: name,
    type: document.getElementById("sugType").value,
    ring: document.getElementById("sugRing").value,
    armor: document.getElementById("sugArmor").value,
    skill: document.getElementById("sugSkill").value,
    suggester: myNick,
    timestamp: Date.now()
  };
  push(ref(db, `suggestions/${currentDefense}`), data).then(() => {
    alert("ì œë³´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë“±ë¡ë©ë‹ˆë‹¤.");
    closeSuggestModal();
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    document.getElementById("sugName").value = "";
    document.getElementById("sugType").value = "";
    document.getElementById("sugRing").value = "";
    document.getElementById("sugArmor").value = "";
    document.getElementById("sugSkill").value = "";
  });
};

function renderSuggestions() {
  const listDiv = document.getElementById("suggestionList");
  onValue(ref(db, "suggestions"), snap => {
    listDiv.innerHTML = "";
    const allSugs = snap.val();
    if(!allSugs) { listDiv.innerHTML = "(ëŒ€ê¸° ì¤‘ì¸ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤)"; return; }
    
    Object.entries(allSugs).forEach(([defKey, suggs]) => {
      const defName = defenseDataCache[defKey] ? defenseDataCache[defKey].name : "ì•Œìˆ˜ì—†ëŠ” ë°©ì–´íŒ€";
      Object.entries(suggs).forEach(([sugKey, data]) => {
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.innerHTML = `
          <div style="font-weight:bold; color:#fff; margin-bottom:5px;">[${defName}] ìƒëŒ€ë¡œ ì œë³´ë¨</div>
          <div style="margin-bottom:5px;"><span style="color:var(--accent);">${data.name}</span> <small style="color:#777;">(by ${data.suggester})</small></div>
          <div style="font-size:0.8rem; color:#aaa; margin-bottom:8px;">${data.type} / ${data.ring} / ${data.armor}</div>
          <div style="display:flex; gap:5px;">
            <button class="mini-btn bg-blue" onclick="approveSuggestion('${defKey}', '${sugKey}')">ìŠ¹ì¸</button>
            <button class="mini-btn bg-red" onclick="rejectSuggestion('${defKey}', '${sugKey}')">ê±°ì ˆ</button>
          </div>
        `;
        listDiv.appendChild(div);
      });
    });
  });
}

window.approveSuggestion = async (defKey, sugKey) => {
  if(!confirm("ì´ ë±ì„ ìŠ¹ì¸í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í• ê¹Œìš”?")) return;
  const snap = await get(ref(db, `suggestions/${defKey}/${sugKey}`));
  if(!snap.exists()) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
  const data = snap.val();
  const newAttack = {
    name: data.name, type: data.type, ring: data.ring, armor: data.armor, skill: data.skill,
    win: 0, lose: 0,
    maker: data.suggester // ì œë³´ì ì €ì¥
  };
  await push(ref(db, `defenseTeams/${defKey}/attackTeams`), newAttack);
  await remove(ref(db, `suggestions/${defKey}/${sugKey}`));
  alert("ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

window.rejectSuggestion = async (defKey, sugKey) => {
  if(!confirm("ì •ë§ ê±°ì ˆí•˜ê³  ì‚­ì œí• ê¹Œìš”?")) return;
  await remove(ref(db, `suggestions/${defKey}/${sugKey}`));
  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
};

/* ìƒì„¸ ì •ë³´ ë° ì „ì  */
async function loadRecentRecord(defenseKey, attackKey){
  const snap = await get(ref(db,"logs"));
  const recordDiv = document.getElementById("recentRecord");
  if(!snap.exists()) { recordDiv.innerHTML = "-"; return; }
  
  const logs = Object.values(snap.val())
    .filter(v => v.defense === defenseKey && v.attack === attackKey)
    .sort((a,b)=>b.time-a.time).slice(0,5);
  let html = "";
  logs.forEach(v => { html += (v.result === "win" ? "<span style='color:#4caf50;'>W</span> " : "<span style='color:#f44336;'>L</span> "); });
  recordDiv.innerHTML = html || "-";
}

window.selectAttack = (dk, ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap => {
    const d = snap.val(); if(!d) return;
    document.getElementById("attackCard").style.display = "block";
    document.getElementById("cardName").textContent = d.name;
    // [ì¶”ê°€ë¨] ì œë³´ì í‘œì‹œ
    document.getElementById("cardMaker").textContent = d.maker ? `By. ${d.maker}` : "";

    document.getElementById("cardWin").textContent = d.win;
    document.getElementById("cardLose").textContent = d.lose;
    
    const total = d.win + d.lose;
    const rateVal = total ? Math.round(d.win / total * 100) : 0;
    document.getElementById("cardRate").textContent = rateVal;
    document.getElementById("cardFire").textContent = rateVal >= 70 ? "ğŸ”¥" : "";
    document.getElementById("cardType").textContent = d.type || "-";
    document.getElementById("cardRing").textContent = d.ring || "-";
    document.getElementById("cardArmor").innerHTML = (d.armor || "-").replace(/\n/g,"<br>");
    document.getElementById("cardSkill").textContent = d.skill || "-";
    loadRecentRecord(dk, ak);

    document.getElementById("atkName").value=d.name; 
    document.getElementById("atkType").value=d.type; 
    document.getElementById("ringRec").value=d.ring; 
    document.getElementById("armorRec").value=d.armor; 
    document.getElementById("skillOrder").value=d.skill;
  });
};

async function canInput(){
  const today = new Date().toISOString().slice(0,10);
  const snap = await get(ref(db,"logs"));
  let cnt = 0;
  if(snap.exists()){
    Object.values(snap.val()).forEach(v=>{ if(v.nick===myNick && v.date===today) cnt++; });
  }
  return cnt < 5;
}

async function writeLog(result){
  if(!currentDefense || !currentAttack) return alert("âš ï¸ íŒ€ ì„ íƒ ì˜¤ë¥˜");
  const snap = await get(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`));
  if(!snap.exists()) { loadAttackTeams(currentDefense); return; }
  const atk = snap.val();
  set(push(ref(db,"logs")),{
    nick: myNick, result, defense: currentDefense, attack: currentAttack,
    attackName: atk.name || "", attackType: atk.type || "",
    date: new Date().toISOString().slice(0,10), time: Date.now()
  });
}

window.addWin = async () => {
  if(!currentDefense || !currentAttack) return alert("âš ï¸ ì„ íƒ í•„ìš”");
  if (!await canInput()) return alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ");
  if (!confirm(`ìŠ¹ë¦¬ ê¸°ë¡?`)) return;
  const w = +document.getElementById("cardWin").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { win: w + 1 });
  writeLog("win");
};

window.addLose = async () => {
  if(!currentDefense || !currentAttack) return alert("âš ï¸ ì„ íƒ í•„ìš”");
  if (!await canInput()) return alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ");
  if (!confirm(`íŒ¨ë°° ê¸°ë¡?`)) return;
  const l = +document.getElementById("cardLose").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { lose: l + 1 });
  writeLog("lose");
};

window.resetRecord = () => {
  if(!checkPW()) return;
  if(!currentAttack) return alert("ê³µê²©íŒ€ ì„ íƒ í•„ìš”");
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};
window.addDefense = ()=>{ if(checkPW()) set(push(ref(db,"defenseTeams")),{name:document.getElementById("defName").value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };
window.addAttack = ()=>{
  if(!checkPW()) return;
  set(push(ref(db,`defenseTeams/${currentDefense}/attackTeams`)),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, armor:document.getElementById("armorRec").value, 
    skill:document.getElementById("skillOrder").value, win:0, lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW() || !currentAttack) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, armor:document.getElementById("armorRec").value, 
    skill:document.getElementById("skillOrder").value
  });
  alert("ìˆ˜ì •ì™„ë£Œ");
};
window.delAttack = ()=>{ if(checkPW() && currentAttack) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

/* --- ë­í‚¹ ë° ìœ ì € ê´€ë¦¬ ë¡œì§ --- */
onValue(ref(db,"logs"), snap => {
  allLogsCache = snap.val() || {}; 
  renderRanking();
  if(adminOpen) renderAdminUserList();
});

function renderRanking() {
  const rankingList = document.getElementById("rankingList");
  const msg = document.getElementById("moreRankMsg");
  rankingList.innerHTML = "";

  // 1. ë¡œê·¸ê°€ ì—†ì„ ê²½ìš° ì²˜ë¦¬
  if(!Object.keys(allLogsCache).length) {
    rankingList.innerHTML = "<div style='text-align:center; padding:10px; color:#555;'>ê¸°ë¡ ì—†ìŒ</div>";
    document.getElementById("myStats").textContent = "ë‚´ ì „ì : ê¸°ë¡ ì—†ìŒ"; 
    return;
  }

  // 2. ìœ ì €ë³„ ë°ì´í„° ì§‘ê³„
  const userLogs = {};
  Object.values(allLogsCache).forEach(v => {
    if (!userLogs[v.nick]) userLogs[v.nick] = [];
    userLogs[v.nick].push(v);
  });

  const rankingData = Object.keys(userLogs).map(nick => {
    const logs = userLogs[nick];
    
    // ìµœì‹ ìˆœ ì •ë ¬
    logs.sort((a, b) => b.time - a.time);

    // ì „ì²´ ì „ì 
    const totalWin = logs.filter(l => l.result === "win").length;
    const totalLose = logs.filter(l => l.result === "lose").length;
    
    // ìµœê·¼ 30íŒ ì „ì  (slice 0,30)
    const recentLogs = logs.slice(0, 30);
    const recentWin = recentLogs.filter(l => l.result === "win").length;
    const recentLose = recentLogs.filter(l => l.result === "lose").length;

    return { nick, totalWin, totalLose, recentWin, recentLose };
  });

  // 3. ì „ì²´ ìŠ¹ìˆ˜ ê¸°ì¤€ ë­í‚¹ ì •ë ¬
  rankingData.sort((a, b) => b.totalWin - a.totalWin);

  // 4. ë‚´ ì „ì  í‘œì‹œ ì—…ë°ì´íŠ¸
  const myData = rankingData.find(d => d.nick === myNick);
  const myStatDiv = document.getElementById("myStats");
  if(myData) {
    const myRankIndex = rankingData.indexOf(myData);
    const total = myData.totalWin + myData.totalLose;
    const rate = total ? Math.round(myData.totalWin / total * 100) : 0;
    myStatDiv.innerHTML = `ë‚´ ì „ì : ${myRankIndex + 1}ìœ„ / ${myData.totalWin}ìŠ¹ ${myData.totalLose}íŒ¨ (${rate}%)`;
    myStatDiv.style.color = "#4facfe";
  } else {
    myStatDiv.innerHTML = "ë‚´ ì „ì : ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"; 
    myStatDiv.style.color = "#888";
  }

  // 5. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  let hiddenCount = 0;
  rankingData.forEach((d, index) => {
    if(!adminOpen && index >= 10) { hiddenCount++; return; }

    // ë±ƒì§€ ë° ìŠ¤íƒ€ì¼
    let badge = ""; 
    let nickStyle = "color:#fff; font-weight:bold;";
    if(index === 0) { badge = "ğŸ¥‡"; nickStyle = "color:#FFD700; font-weight:bold;"; }
    else if(index === 1) { badge = "ğŸ¥ˆ"; nickStyle = "color:#C0C0C0; font-weight:bold;"; }
    else if(index === 2) { badge = "ğŸ¥‰"; nickStyle = "color:#CD7F32; font-weight:bold;"; }
    else { badge = `<span style='width:20px; display:inline-block; text-align:center; color:#666;'>${index+1}</span>`; }

    // ì „ì²´ ìŠ¹ë¥  ê³„ì‚°
    const total = d.totalWin + d.totalLose;
    const winRate = total ? Math.round(d.totalWin / total * 100) : 0;

    // ìµœê·¼ 30íŒ ìŠ¹ë¥  ë° í¬ë§·íŒ… (+25w/5l 84%ğŸ”¥)
    const rTotal = d.recentWin + d.recentLose;
    const rRate = rTotal ? Math.round(d.recentWin / rTotal * 100) : 0;
    
    // ë¶ˆê½ƒ ë¡œì§: ìµœê·¼ ì „ì ì´ ìˆê³  ìŠ¹ë¥ ì´ 70% ì´ìƒì¼ ë•Œ
    const fire = (rTotal > 0 && rRate >= 70) ? "ğŸ”¥" : "";
    
    // í…ìŠ¤íŠ¸ ìƒ‰ìƒ: ë¶ˆê½ƒì´ ë¶™ìœ¼ë©´ ì•½ê°„ ë” ë°ê²Œ, ì•„ë‹ˆë©´ ì–´ë‘¡ê²Œ
    const subInfoColor = fire ? "#aaa" : "#555"; 

    // [ìˆ˜ì •ë¨] ê¸°ì¡´ ì½”ë“œì˜ ì˜¤íƒ€ document.("div") ìˆ˜ì •
    const div = document.createElement("div"); 
    div.className = "rank-row";
    if(adminOpen && index >= 10) div.style.background = "rgba(255,0,0,0.05)"; 

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        ${badge} <span style="${nickStyle}">${d.nick}</span>
      </div>
      <div style="text-align:right;">
        <div style="color:#ddd; font-size:0.95rem;">
          <span style="color:${d.totalWin>0?'#4caf50':'#666'}">${d.totalWin}ìŠ¹</span> / ${d.totalLose}íŒ¨ (${winRate}%)
        </div>
        <div style="color:${subInfoColor}; font-size:0.75rem; margin-top:3px; letter-spacing:-0.5px;">
          (+${d.recentWin}w/${d.recentLose}l ${rRate}%${fire})
        </div>
      </div>
    `;
    rankingList.appendChild(div);
  });

  msg.style.display = hiddenCount > 0 ? "block" : "none";
}


/* ê´€ë¦¬ì: ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì • */
window.adjustScore = async (nick, type, delta) => {
  if(delta === 1) {
    set(push(ref(db,"logs")),{
      nick: nick, result: type, defense: "admin", attack: "manual_adjust",
      attackName: "ê´€ë¦¬ììˆ˜ì •", attackType: "",
      date: new Date().toISOString().slice(0,10), time: Date.now()
    });
  } else {
    const snap = await get(ref(db, "logs"));
    if(!snap.exists()) return alert("ê¸°ë¡ ì—†ìŒ");
    
    const logs = Object.entries(snap.val())
      .map(([k,v]) => ({...v, key:k}))
      .filter(v => v.nick === nick && v.result === type)
      .sort((a,b) => b.time - a.time);
      
    if(logs.length === 0) return alert("ì°¨ê°í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
    await remove(ref(db, `logs/${logs[0].key}`));
  }
};

/* ê´€ë¦¬ììš© ìœ ì € ë¦¬ìŠ¤íŠ¸ */
function renderAdminUserList() {
  const listDiv = document.getElementById("adminUserList");
  listDiv.innerHTML = "";
  
  const stat = {};
  Object.values(allLogsCache).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0, l:0};
    if(v.result === "win") stat[v.nick].w++;
    else stat[v.nick].l++;
  });

  const sorted = Object.keys(stat).sort();
  sorted.forEach(nick => {
    const val = stat[nick];
    const div = document.createElement("div");
    div.style.padding = "10px";
    div.style.borderBottom = "1px solid #333";
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    
    div.innerHTML = `
      <span style="font-weight:bold; width:80px;">${nick}</span>
      <div style="display:flex; align-items:center; gap:5px;">
        <span style="color:#4caf50; font-size:0.8rem;">ìŠ¹:${val.w}</span>
        <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','win',1)">+</button>
        <button class="mini-btn bg-red" onclick="adjustScore('${nick}','win',-1)">-</button>
        <span style="color:#dc3545; font-size:0.8rem; margin-left:5px;">íŒ¨:${val.l}</span>
        <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','lose',1)">+</button>
        <button class="mini-btn bg-red" onclick="adjustScore('${nick}','lose',-1)">-</button>
      </div>
    `;
    listDiv.appendChild(div);
  });
}
</script>
</body>
</html>
