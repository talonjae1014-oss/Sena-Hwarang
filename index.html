<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_PW = "1513";
let currentUser="", currentDefenseKey="", currentAttackKey="";
let currentDefenseName="", currentAttackName="";
let adminOpened=false;

/* ë¡œê·¸ì¸ */
window.enterSite=()=>{
  const n=nicknameInput.value.trim();
  if(!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
  currentUser=n;
  localStorage.setItem("guildUser",n);
  loginScreen.style.display="none";
  mainUI.style.display="block";
};
window.onload=()=>{
  const s=localStorage.getItem("guildUser");
  if(s){currentUser=s;loginScreen.style.display="none";mainUI.style.display="block";}
};

/* ê´€ë¦¬ì */
function checkPW(){
  const p=prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if(p!==ADMIN_PW){alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");return false;}
  return true;
}
window.toggleAdmin=()=>{
  if(!adminOpened){
    if(!checkPW()) return;
    adminOpened=true;
    adminPanel.style.display="block";
    adminToggleBtn.textContent="âˆ’ ê´€ë¦¬ì ë‹«ê¸°";
    loadLogs();
  }else{
    adminOpened=false;
    adminPanel.style.display="none";
    adminToggleBtn.textContent="+ ê´€ë¦¬ììš©";
  }
};

/* ë°©ì–´íŒ€ */
onValue(ref(db,"defenseTeams"),snap=>{
  defenseSelect.innerHTML="";
  const d=snap.val(); if(!d) return;
  Object.entries(d).forEach(([k,v])=>{
    const o=document.createElement("option");
    o.value=k; o.textContent=v.name;
    defenseSelect.appendChild(o);
  });
});

/* ê³µê²©íŒ€ */
window.loadAttackTeams=(dKey)=>{
  currentDefenseKey=dKey;
  onValue(ref(db,`defenseTeams/${dKey}`),snap=>{
    const def=snap.val(); if(!def) return;
    currentDefenseName=def.name;
    attackList.innerHTML="";
    Object.entries(def.attackTeams||{}).forEach(([k,v])=>{
      const t=v.win+v.lose;
      const r=t?Math.round(v.win/t*100):0;
      const b=document.createElement("button");
      b.textContent=`${r>=70?"ğŸ”¥ ":""}${v.name} (${r}%)`;
      b.onclick=()=>selectAttack(dKey,k);
      attackList.appendChild(b);
    });
  });
};

window.selectAttack=(dKey,aKey)=>{
  currentAttackKey=aKey;
  onValue(ref(db,`defenseTeams/${dKey}/attackTeams/${aKey}`),snap=>{
    const d=snap.val(); if(!d) return;
    currentAttackName=d.name;
    win.textContent=d.win;
    lose.textContent=d.lose;
    rate.textContent=(d.win+d.lose)?Math.round(d.win/(d.win+d.lose)*100):0;
  });
};

/* ë¡œê·¸ */
function saveLog(result){
  push(ref(db,"logs"),{
    user: currentUser,
    defense: currentDefenseName,
    attack: currentAttackName,
    result,
    time: Date.now()
  });
}
window.addWin=()=>{
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),
    {win:+win.textContent+1});
  saveLog("WIN");
};
window.addLose=()=>{
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),
    {lose:+lose.textContent+1});
  saveLog("LOSE");
};

/* ë¡œê·¸ + ì‚¬ëŒë³„ í†µê³„ */
function loadLogs(){
  onValue(ref(db,"logs"),snap=>{
    logList.innerHTML="";
    statList.innerHTML="";
    const data=snap.val(); if(!data) return;

    const stats={};

    Object.values(data).reverse().forEach(l=>{
      const d=document.createElement("div");
      d.textContent=
        `[${new Date(l.time).toLocaleString()}] ${l.user} | ${l.defense} â†’ ${l.attack} | ${l.result}`;
      logList.appendChild(d);

      if(!stats[l.user]) stats[l.user]={win:0,lose:0};
      l.result==="WIN"?stats[l.user].win++:stats[l.user].lose++;
    });

    Object.entries(stats).forEach(([u,s])=>{
      const t=s.win+s.lose;
      const r=t?Math.round(s.win/t*100):0;
      const d=document.createElement("div");
      d.textContent=`${u} | ìŠ¹ ${s.win} / íŒ¨ ${s.lose} | ${r}%`;
      statList.appendChild(d);
    });
  });
}
</script>

<style>
body{background:#111;color:#fff;font-family:sans-serif;padding:12px}
button,input,select{width:100%;margin-top:8px;padding:12px}
button{background:#333;color:#fff;border:none;border-radius:6px}
.winBtn{background:#4aa3ff}
.loseBtn{background:#ff5c5c}
.adminToggle{background:#f1c40f;color:#000;font-weight:bold}

.login-screen{
  position:fixed; inset:0;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.85)),
    url("data:image/jpeg;base64,REPLACE_BASE64_HERE");
  background-size:cover;
  background-position:center;
  display:flex;align-items:center;justify-content:center;
}
.login-box{background:rgba(0,0,0,.6);padding:30px;border-radius:14px;text-align:center}
.admin{display:none;margin-top:20px;border-top:2px solid #444;padding-top:15px}
.logBox{max-height:200px;overflow:auto;border:1px solid #444;padding:8px}
</style>
</head>

<body>

<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h1>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</h1>
    <input id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
    <button onclick="enterSite()">ì…ì¥í•˜ê¸°</button>
  </div>
</div>

<div id="mainUI" style="display:none;">
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>
<div id="attackList"></div>

<button class="winBtn" onclick="addWin()">ìŠ¹</button>
<button class="loseBtn" onclick="addLose()">íŒ¨</button>
<div>ìŠ¹ <span id="win">0</span> / íŒ¨ <span id="lose">0</span> / ìŠ¹ë¥  <span id="rate">0</span>%</div>

<button id="adminToggleBtn" class="adminToggle" onclick="toggleAdmin()">+ ê´€ë¦¬ììš©</button>

<div id="adminPanel" class="admin">
  <h3>ğŸ“œ ë¡œê·¸</h3>
  <div id="logList" class="logBox"></div>
  <h3>ğŸ“Š ì‚¬ëŒë³„ ìŠ¹ë¥ </h3>
  <div id="statList" class="logBox"></div>
</div>
</div>

</body>
</html>
