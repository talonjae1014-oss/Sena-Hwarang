<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "1513";

let myNick = "";
let currentDefense = "";
let currentAttack = "";
let adminOpen = false;


/* ìµœì´ˆ ë‹‰ë„¤ì„ */
window.onload = () => {
  myNick = localStorage.getItem("nickname");
  if (!myNick) {
    loginScreen.style.display = "block";
    mainScreen.style.display = "none";
  }
};

window.enterSite = () => {
  const n = nickInput.value.trim();
  if (!n) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
  myNick = n;
  localStorage.setItem("nickname", myNick);
  loginScreen.style.display = "none";
  mainScreen.style.display = "block";
document.getElementById("currentNick").textContent = `í˜„ì¬ ë‹‰ë„¤ì„ : ${myNick}`; 
};

/* ê´€ë¦¬ì ë¹„ë²ˆ */
function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if(pw !== ADMIN_PW){
    alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    return false;
  }
  return true;
}

/* ê´€ë¦¬ì í† ê¸€ */
window.toggleAdmin = () => {
  if(!adminOpen){
    if(!checkPW()) return;
    adminPanel.style.display="block";
    adminBtn.textContent="âˆ’ ê´€ë¦¬ììš© ë‹«ê¸°";
    adminOpen=true;
  }else{
    adminPanel.style.display="none";
    adminBtn.textContent="+ ê´€ë¦¬ììš©";
    adminOpen=false;
  }
};

/* í•˜ë£¨ 5íšŒ ì œí•œ */
async function canInput(){
  const today = new Date().toISOString().slice(0,10);
  const snap = await get(ref(db,"logs"));
  let cnt = 0;
  if(snap.exists()){
    Object.values(snap.val()).forEach(v=>{
      if(v.nick===myNick && v.date===today) cnt++;
    });
  }
  return cnt < 5;
}

/* ë¡œê·¸ */
function writeLog(result){
  set(push(ref(db,"logs")),{
    nick: myNick,
    result,
    defense: currentDefense,
    attack: currentAttack,
    date: new Date().toISOString().slice(0,10),
    time: Date.now()
  });
}

/* ë°©ì–´íŒ€ */
onValue(ref(db,"defenseTeams"),snap=>{
  defenseSelect.innerHTML="";
  const d=snap.val(); if(!d) return;
  Object.entries(d).forEach(([k,v])=>{
    const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
    const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
    const rate = (tWins+tLose)?Math.round(tWins/(tWins+tLose)*100):0;
    const o=document.createElement("option");
    o.value=k;
    o.textContent=`${v.name} (${rate}% / ${tWins}ìŠ¹ ${tLose}íŒ¨)`;
    defenseSelect.appendChild(o);
  });
  loadAttackTeams(defenseSelect.value);
});

/* ê³µê²©íŒ€ */
window.loadAttackTeams = (dk) => {
  currentDefense = dk;
  attackList.innerHTML="";
  onValue(ref(db,`defenseTeams/${dk}/attackTeams`),snap=>{
    attackList.innerHTML="";
    const d=snap.val(); if(!d) return;
    Object.entries(d).forEach(([ak,av])=>{
      const t=av.win+av.lose;
      const r=t?Math.round(av.win/t*100):0;
      const b=document.createElement("button");
      b.textContent=`${r>=70?"ğŸ”¥ ":""}${av.name} ${r}% (${av.win}ìŠ¹ ${av.lose}íŒ¨)`;
      b.onclick=()=>selectAttack(dk,ak);
      attackList.appendChild(b);
    });
  });
};

async function loadRecentRecord(defenseKey, attackKey){
  const snap = await get(ref(db,"logs"));
  if(!snap.exists()) return;

  // ìµœì‹ ìˆœ ì •ë ¬
  const logs = Object.values(snap.val())
    .filter(v =>
      v.defense === defenseKey &&
      v.attack === attackKey
    )
    .sort((a,b)=>b.time-a.time)
    .slice(0,5); // ìµœê·¼ 5íŒ

  let html = "";
  logs.forEach(v=>{
    if(v.result === "win") html += "ğŸŸ¢ ";
    if(v.result === "lose") html += "ğŸ”´ ";
  });

  document.getElementById("recentRecord").innerHTML = html || "-";
}

/* ê³µê²©íŒ€ ì„ íƒ */
window.selectAttack = (dk,ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`),snap=>{
    const d=snap.val(); if(!d) return;
    win.textContent=d.win;
    lose.textContent=d.lose;
    const t=d.win+d.lose;
    rate.textContent=t?Math.round(d.win/t*100):0;

    atkName.value=d.name;
    atkType.value=d.type;
    ringRec.value=d.ring;
    armorRec.value=d.armor;
    skillOrder.value=d.skill;

    /* === ê³µê²©íŒ€ ìš”ì•½ ì¹´ë“œ === */
    attackCard.style.display = "block";

    cardName.textContent = d.name;
    cardWin.textContent = d.win;
    cardLose.textContent = d.lose;

    const total = d.win + d.lose;
    cardTotal.textContent = total;

    const rateVal = total ? Math.round(d.win / total * 100) : 0;
    cardRate.textContent = rateVal;
    cardFire.textContent = rateVal >= 70 ? "ğŸ”¥" : "";

    cardType.textContent = d.type || "-";
    cardRing.textContent = d.ring || "-";
    cardArmor.innerHTML = (d.armor || "-").replace(/\n/g,"<br>");
    cardSkill.textContent = d.skill || "-";

loadRecentRecord(dk, ak);

  });
};

/* ìŠ¹/íŒ¨ */
window.addWin = async () => {
  if(!currentAttack) return;
  if(!await canInput()) return alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ");
  if(!confirm("ìŠ¹ë¦¬í•˜ì…¨ë‚˜ìš”?\nì¥ë‚œìœ¼ë¡œ ëˆ„ë¥´ë©´ ê¸¸ë§ˆê°€ ë§¤ìš° í™”ë‚©ë‹ˆë‹¤.")) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:+win.textContent+1});
  writeLog("win");
};
window.addLose = async () => {
  if(!currentAttack) return;
  if(!await canInput()) return alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ");
  if(!confirm("íŒ¨ë°°í•˜ì…¨ë‚˜ìš”?\nì¥ë‚œìœ¼ë¡œ ëˆ„ë¥´ë©´ ê¸¸ë§ˆê°€ ë§¤ìš° í™”ë‚©ë‹ˆë‹¤.")) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{lose:+lose.textContent+1});
  writeLog("lose");
};

/* ì´ˆê¸°í™” */
window.resetRecord = () => {
  if(!checkPW()) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};

/* ê´€ë¦¬ì CRUD */
window.addDefense = ()=>{ if(checkPW()) set(push(ref(db,"defenseTeams")),{name:defName.value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };

window.addAttack = ()=>{
  if(!checkPW()) return;
  set(push(ref(db,`defenseTeams/${currentDefense}/attackTeams`)),{
    name:atkName.value,
    type:atkType.value,
    ring:ringRec.value,
    armor:armorRec.value,
    skill:skillOrder.value,
    win:0,lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW()) return;
  if(!confirm("ë°˜ì§€ / ë°©ì–´êµ¬ / ìŠ¤í‚¬ ìˆœì„œ ì •ë³´ê°€ ë³€ê²½ë©ë‹ˆë‹¤.\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{
    name:atkName.value,
    type:atkType.value,
    ring:ringRec.value,
    armor:armorRec.value,
    skill:skillOrder.value
  });
};
window.delAttack = ()=>{ if(checkPW()) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

/* ê°œì¸ ë­í‚¹ */

onValue(ref(db,"logs"), snap => {
  if(!snap.exists()) return;

  const stat = {};

  Object.values(snap.val()).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0,l:0};

    if(v.result === "win") stat[v.nick].w += 1;
    if(v.result === "lose") stat[v.nick].l += 1;

    if(v.type === "win") stat[v.nick].w += v.delta;
    if(v.type === "lose") stat[v.nick].l += v.delta;
  });

  const list = Object.entries(stat).map(([n,v])=>{
    const t = v.w + v.l;
    const r = t ? Math.round(v.w / t * 100) : 0;
    return { n, w:v.w, l:v.l, r };
  })
  .sort((a,b)=>b.w - a.w); // ìŠ¹ë¦¬ íšŸìˆ˜ ê¸°ì¤€

  /* ğŸ† TOP3 */
  rankBox.innerHTML = "<h4>ğŸ† ìŠ¹ë¦¬ TOP3</h4>";

  list.slice(0,3).forEach((u,i)=>{
    const medal = ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i];
    const fire = u.r >= 70 ? " ğŸ”¥" : "";

    rankBox.innerHTML += `
      <div style="
        border:1px solid #444;
        border-radius:10px;
        padding:10px;
        margin-bottom:8px;
        background:#111;
      ">
        <b>${medal} ${u.n}${fire}</b><br>
        ${u.w}ìŠ¹ ${u.l}íŒ¨<br>
        ìŠ¹ë¥  ${u.r}%
      </div>
    `;
  });

  /* ğŸ‘¤ ë‚´ ì¹´ë“œ */
  const myIndex = list.findIndex(v=>v.n === myNick);
  if(myIndex !== -1){
    const me = list[myIndex];

    myCard.style.display = "block";
    myNickCard.textContent = me.n;
    myWL.textContent = `${me.w}ìŠ¹ ${me.l}íŒ¨`;
    myRate.textContent = me.r;
    myRank.textContent = `${myIndex+1}ìœ„ / ${list.length}ëª…`;
  } else {
    myCard.style.display = "none";
  }
});

/* ğŸ‘¤ ê°œì¸ í”„ë¡œí•„ ì¹´ë“œ */
onValue(ref(db, "logs"), async (snap) => {
  if (!snap.exists() || !myNick) return;

  let win = 0;
  let lose = 0;

  /* ê°œì¸ ìŠ¹/íŒ¨ ê³„ì‚° */
  Object.values(snap.val()).forEach(v => {
    if (v.nick !== myNick) return;

    if (v.result === "win") win++;
    if (v.result === "lose") lose++;

    if (v.type === "win") win += v.delta;
    if (v.type === "lose") lose += v.delta;
  });

  const total = win + lose;
  const rate = total ? Math.round(win / total * 100) : 0;

  profileNick.textContent = myNick;
  profileWin.textContent = win;
  profileLose.textContent = lose;
  profileRate.textContent = rate;
});

/* ì„ í˜¸ ê³µê²©íŒ€ TOP3 */
onValue(ref(db, "defenseTeams"), (snap) => {
  if (!snap.exists()) return;

  const stats = {};

  Object.values(snap.val()).forEach(def => {
    Object.values(def.attackTeams || {}).forEach(atk => {
      const total = atk.win + atk.lose;
      if (total < 3) return; // í‘œë³¸ ë„ˆë¬´ ì ì€ ê±´ ì œì™¸

      const rate = Math.round(atk.win / total * 100);
      stats[atk.name] = {
        name: atk.name,
        type: atk.type || "",
        rate
      };
    });
  });

  const top = Object.values(stats)
    .sort((a, b) => b.rate - a.rate)
    .slice(0, 3);

  profileFav.innerHTML = "";
  ["1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£"].forEach((m, i) => {
    if (top[i]) {
      profileFav.innerHTML +=
        `${m} ${top[i].type}-${top[i].name} (${top[i].rate}%)<br>`;
    }
  });
});

onValue(ref(db,"logs"), snap=>{
  const sel = document.getElementById("adminNickSelect");
  if(!sel || !snap.exists()) return;

  sel.innerHTML = "";
  const nicks = [...new Set(
    Object.values(snap.val()).map(v=>v.nick)
  )];

  nicks.forEach(n=>{
    const o=document.createElement("option");
    o.value=n;
    o.textContent=n;
    sel.appendChild(o);
  });
});

window.adminLogAdjust = (type, delta) => {
  if(!checkPW()) return;

  const sel = document.getElementById("adminNickSelect");
  if(!sel || !sel.value) return alert("ë‹‰ë„¤ì„ ì„ íƒ");

  if(!confirm(`${sel.value} ${type} ${delta>0?"+1":"-1"} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  set(push(ref(db,"logs")),{
    nick: sel.value,
    type: type,     // win / lose
    delta: delta,   // +1 / -1
    date: new Date().toISOString().slice(0,10),
    time: Date.now(),
    admin: true
  });

  alert("ë‹‰ë„¤ì„ ë¡œê·¸ ìˆ˜ì • ì™„ë£Œ");
};


</script>

<style>
body{background:#111;color:#fff;font-family:sans-serif;padding:12px}
button,input,select,textarea{width:100%;margin-top:8px;padding:12px}
.win{background:#4aa3ff}
.lose{background:#ff5c5c}
.adminBtn{background:#f1c40f;color:#000;font-weight:bold}
.admin{display:none;border-top:2px solid #444;margin-top:20px;padding-top:15px}
.footer{margin-top:30px;border:1px solid #555;padding:10px;text-align:center}
.small{font-size:12px;color:#aaa}
</style>
</head>

<body>

<div id="loginScreen" style="display:none">
<h2>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</h2>
<input id="nickInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
<div class="small">ë„ì–´ì“°ê¸°ì—†ì´,í—·ê°ˆë¦¬ì§€ì•Šê²Œ ì ì–´ì£¼ì„¸ìš”! ë„ˆë¬´ ê¸¸ë©´ ì¤„ì—¬ë„ ë©ë‹ˆë‹¤<br>ex)6ì„±ì „ë°˜25ê°œë§Œìš” â†’ 6ì„±ì „ë°˜</div>
<button onclick="enterSite()">ì…ì¥í•˜ê¸°</button>
</div>

<div id="mainScreen">

<div id="currentNick" style="
position:fixed;
top:10px;
right:12px;
font-size:13px;
color:#f1c40f;
">
</div>

<!-- ğŸ‘¤ í”„ë¡œí•„ ì¹´ë“œ -->
<div id="profileCard" style="
  border:1px solid #444;
  padding:10px;
  border-radius:8px;
  margin:12px 0;
  background:#000;
  font-size:13px;
">
  <div style="font-weight:bold;margin-bottom:6px">ğŸ‘¤ í”„ë¡œí•„</div>

  <div>í˜„ì¬ ì ‘ì†ì¤‘ ë‹‰ë„¤ì„ : <b id="profileNick"></b></div>
  <div>
    ì´ë²ˆ ì‹œì¦Œ ì „ì  :
    <b><span id="profileRate">0</span>%</b>
    (<span id="profileWin">0</span>ìŠ¹
    <span id="profileLose">0</span>íŒ¨)
  </div>

  <div style="margin-top:6px">ì„ í˜¸ ê³µê²©íŒ€ :</div>
  <div id="profileFav" style="margin-left:8px"></div>
</div>

<h3>ğŸ¯ ê³µê²©í•  ëŒ€ìƒ ì„ íƒ</h3>
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>

<h3>âš” ê³µê²©íŒ€ ëª©ë¡</h3>
<div id="attackList"></div>

<div id="attackCard" style="display:none;
  border:2px solid #444;
  padding:14px;
  margin:12px 0;
  border-radius:8px;
  background:#000;">
  
  <div style="font-size:18px;font-weight:bold;margin-bottom:6px">
    âš” ê³µê²©íŒ€ : <span id="cardName"></span>
  </div>

  <div>
    ìŠ¹ë¥  : <span id="cardRate"></span>% 
    <span id="cardFire" style="color:#ff6b6b"></span>
  </div>
  <div>
    ì „ì  : <span id="cardWin"></span>ìŠ¹ /
    <span id="cardLose"></span>íŒ¨
    (<span id="cardTotal"></span>íŒ)
  </div>

<div style="margin-top:6px">
  ìµœê·¼ ì „ì  :
  <span id="recentRecord"></span>
</div>

  <hr style="border-color:#333;margin:10px 0">

  <div>â–¶ ì¶”ì²œ íƒ€ì… : <b><span id="cardType"></span></b></div>
  <div>â–¶ ë°˜ì§€ ì¶”ì²œ<br><span id="cardRing"></span></div>
  <div>â–¶ ë°©ì–´êµ¬ ì¶”ì²œ<br><span id="cardArmor"></span></div>
  <div>â–¶ ìŠ¤í‚¬ ìˆœì„œ<br><span id="cardSkill"></span></div>
</div>

<h3>ğŸ“Š ì „ì </h3>
<button class="win" onclick="addWin()">ìŠ¹</button>
<button class="lose" onclick="addLose()">íŒ¨</button>
<div class="small"><a href="#" onclick="resetRecord()">ìŠ¹/íŒ¨ ì´ˆê¸°í™” (ê´€ë¦¬ì)</a></div>
<div>ìŠ¹ <span id="win">0</span> / íŒ¨ <span id="lose">0</span> / ìŠ¹ë¥  <span id="rate">0</span>%</div>

<h3>ğŸ† ê°œì¸ ì „ì </h3>

<div style="display:flex; gap:12px; flex-wrap:wrap">

  <!-- ì™¼ìª½ : ìŠ¹ë¦¬ TOP3 -->
  <div id="rankBox" style="flex:1"></div>

  <!-- ì˜¤ë¥¸ìª½ : ë‚´ ì¹´ë“œ -->
  <div id="myCard" style="
    flex:1;
    border:2px solid #f1c40f;
    border-radius:12px;
    padding:12px;
    background:#000;
    display:none;
  ">
    <h4>ğŸ‘¤ ë‚´ ì „ì </h4>
    <div>ë‹‰ë„¤ì„ : <b id="myNickCard"></b></div>
    <div>ì „ì  : <span id="myWL"></span></div>
    <div>ìŠ¹ë¥  : <span id="myRate"></span>%</div>
    <div>ë‚´ ë“±ìˆ˜ : <b><span id="myRank"></span></b></div>
  </div>

</div>

<button id="adminBtn" class="adminBtn" onclick="toggleAdmin()">+ ê´€ë¦¬ììš©</button>

<div id="adminPanel" class="admin">
<input id="defName" placeholder="ë°©ì–´íŒ€ ì´ë¦„">
<button onclick="addDefense()">ë°©ì–´íŒ€ ì¶”ê°€</button>
<button onclick="delDefense()">ë°©ì–´íŒ€ ì‚­ì œ</button>

<input id="atkName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
<select id="atkType"><option>ì†ê³µ</option><option>ë‚´ì‹¤</option></select>
<input id="ringRec" placeholder="ë°˜ì§€ ì¶”ì²œ">
<textarea id="armorRec" placeholder="ë°©ì–´êµ¬ ì¶”ì²œ"></textarea>
<input id="skillOrder" placeholder="ìŠ¤í‚¬ ìˆœì„œ">
<button onclick="addAttack()">ê³µê²©íŒ€ ì¶”ê°€</button>
<button onclick="editAttack()">ê³µê²©íŒ€ ìˆ˜ì •</button>
<button onclick="delAttack()">ê³µê²©íŒ€ ì‚­ì œ</button>

<h4>ğŸ“Œ ë‹‰ë„¤ì„ë³„ ìŠ¹/íŒ¨ ë¡œê·¸ ìˆ˜ì •</h4>

<select id="adminNickSelect"></select>

<button onclick="adminLogAdjust('win',1)">ìŠ¹ +1</button>
<button onclick="adminLogAdjust('win',-1)">ìŠ¹ -1</button>

<button onclick="adminLogAdjust('lose',1)">íŒ¨ +1</button>
<button onclick="adminLogAdjust('lose',-1)">íŒ¨ -1</button>

</div>

<hr style="margin:15px 0;border-color:#333">

<div class="footer">ì œì‘ì : ë¶ˆë©¸</div>

</div>
</body>
</html>
