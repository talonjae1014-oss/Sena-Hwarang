<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "1513";

let myNickname="";
let currentDefenseKey="";
let currentAttackKey="";
let adminOpened=false;

/* ë‹‰ë„¤ì„ */
window.onload=()=>{
  myNickname = localStorage.getItem("nickname");
  if(!myNickname){
    const n = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
    if(!n){ alert("ë‹‰ë„¤ì„ í•„ìˆ˜"); location.reload(); return; }
    myNickname = n.trim();
    localStorage.setItem("nickname", myNickname);
  }
};

/* ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ */
function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if(pw !== ADMIN_PW){ alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return false; }
  return true;
}

/* ê´€ë¦¬ì í† ê¸€ */
window.toggleAdmin = ()=>{
  if(!adminOpened){
    if(!checkPW()) return;
    adminPanel.style.display="block";
    adminToggleBtn.textContent="âˆ’ ê´€ë¦¬ììš© ë‹«ê¸°";
    adminOpened=true;
  }else{
    adminPanel.style.display="none";
    adminToggleBtn.textContent="+ ê´€ë¦¬ììš©";
    adminOpened=false;
  }
};

/* í•˜ë£¨ ì…ë ¥ ì œí•œ */
async function canInputToday(){
  const today = new Date().toISOString().slice(0,10);
  const snap = await get(ref(db,"logs"));
  let cnt=0;
  if(snap.exists()){
    Object.values(snap.val()).forEach(v=>{
      if(v.nickname===myNickname && v.date===today) cnt++;
    });
  }
  return cnt < 5;
}

/* ë¡œê·¸ */
function writeLog(nick,result){
  set(push(ref(db,"logs")),{
    nickname:nick,
    result,
    date:new Date().toISOString().slice(0,10),
    time:Date.now()
  });
}

/* ë°©ì–´íŒ€ */
onValue(ref(db,"defenseTeams"), snap=>{
  defenseSelect.innerHTML="";
  const d=snap.val(); if(!d) return;

  Object.entries(d).forEach(([k,v])=>{
    let w=0,l=0;
    if(v.attackTeams){
      Object.values(v.attackTeams).forEach(t=>{
        w+=t.win||0; l+=t.lose||0;
      });
    }
    const total=w+l;
    const rate=total?Math.round(w/total*100):0;

    const o=document.createElement("option");
    o.value=k;
    o.textContent=`${v.name} (${rate}% Â· ${w}ìŠ¹ ${l}íŒ¨)`;
    defenseSelect.appendChild(o);
  });

  loadAttackTeams(defenseSelect.value);
});

/* ê³µê²©íŒ€ */
window.loadAttackTeams=(k)=>{
  currentDefenseKey=k;
  attackList.innerHTML="";
  if(!k) return;

  onValue(ref(db,`defenseTeams/${k}/attackTeams`), snap=>{
    attackList.innerHTML="";
    const d=snap.val(); if(!d) return;

    const teams=Object.entries(d).map(([ak,av])=>{
      const t=(av.win||0)+(av.lose||0);
      const r=t?Math.round(av.win/t*100):0;
      return {key:ak,...av,r};
    }).sort((a,b)=>b.r-a.r);

    teams.forEach(t=>{
      const b=document.createElement("button");
      b.textContent=`${t.r>=70?"ğŸ”¥ ":""}${t.name} ${t.r}% (${t.win}ìŠ¹ ${t.lose}íŒ¨)`;
      b.onclick=()=>selectAttack(k,t.key);
      attackList.appendChild(b);
    });
  });
};

/* ê³µê²©íŒ€ ì„ íƒ */
window.selectAttack=(dk,ak)=>{
  currentAttackKey=ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap=>{
    const d=snap.val(); if(!d) return;
    win.textContent=d.win;
    lose.textContent=d.lose;
    const t=d.win+d.lose;
    rate.textContent=t?Math.round(d.win/t*100):0;

    typeView.textContent=d.type;
    ringView.textContent=d.ring;
    armorView.textContent=d.armor;
    skillView.textContent=d.skill;
  });
};

/* ìŠ¹/íŒ¨ */
window.addWin=async()=>{
  if(!currentAttackKey) return;
  if(!await canInputToday()){ alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ"); return; }
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    win:+win.textContent+1
  });
  writeLog(myNickname,"win");
};
window.addLose=async()=>{
  if(!currentAttackKey) return;
  if(!await canInputToday()){ alert("í•˜ë£¨ ìµœëŒ€ 5íšŒ"); return; }
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    lose:+lose.textContent+1
  });
  writeLog(myNickname,"lose");
};

/* ìŠ¹íŒ¨ ì´ˆê¸°í™” */
window.resetRecord=()=>{
  if(!currentAttackKey) return;
  if(!checkPW()) return;
  if(!confirm("ìŠ¹/íŒ¨ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.")) return;

  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    win:0, lose:0
  });
  writeLog("ADMIN","admin_reset");
};

/* ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì • (+1 / -1) */
window.adminAdjust=(type,delta)=>{
  if(!currentAttackKey) return;
  if(!checkPW()) return;

  const path=`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`;
  get(ref(db,path)).then(snap=>{
    const d=snap.val(); if(!d) return;
    const newVal=Math.max(0,(d[type]||0)+delta);

    update(ref(db,path),{ [type]:newVal });
    writeLog("ADMIN",`admin_${type}_${delta>0?"plus":"minus"}`);
  });
};

/* ê°œì¸ ë­í‚¹ */
onValue(ref(db,"logs"), snap=>{
  if(!snap.exists()) return;
  const s={};
  Object.values(snap.val()).forEach(v=>{
    if(v.result!=="win" && v.result!=="lose") return;
    if(!s[v.nickname]) s[v.nickname]={w:0,l:0};
    v.result==="win"?s[v.nickname].w++:s[v.nickname].l++;
  });
  const r=Object.entries(s).map(([n,v])=>{
    const t=v.w+v.l;
    return {n,w:v.w,l:v.l,r:t?Math.round(v.w/t*100):0};
  }).sort((a,b)=>b.r-a.r).slice(0,3);

  const medal=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];
  rankBox.innerHTML="";
  r.forEach((x,i)=>{
    const d=document.createElement("div");
    d.textContent=`${medal[i]} ${x.n} ${x.r}% (${x.w}ìŠ¹ ${x.l}íŒ¨)`;
    rankBox.appendChild(d);
  });
});
</script>

<style>
body{background:#111;color:#fff;font-family:sans-serif;padding:12px}
button,select{width:100%;margin-top:8px;padding:12px}
.winBtn{background:#4aa3ff}
.loseBtn{background:#ff5c5c}
.resetBtn{font-size:12px;background:none;color:#aaa;border:none;text-decoration:underline}
.adminToggle{background:#f1c40f;color:#000;font-weight:bold}
.admin{display:none;border-top:2px solid #444;margin-top:20px;padding-top:15px}
.rank{margin:15px 0;padding:10px;background:#000}
.setting{margin-top:10px;padding:10px;background:#000}
.footer{margin-top:30px;border:1px solid #555;padding:10px;text-align:center}
</style>
</head>

<body>

<h2>ğŸ”¥ í™”ë‘ ê¸¸ë“œì „ ì‚¬ì´íŠ¸</h2>

<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>
<div id="attackList"></div>

<div class="setting">
  <div>íƒ€ì…: <span id="typeView"></span></div>
  <div>ë°˜ì§€: <span id="ringView"></span></div>
  <div>ë°©ì–´êµ¬: <span id="armorView"></span></div>
  <div>ìŠ¤í‚¬ ìˆœì„œ: <span id="skillView"></span></div>
</div>

<h3>ğŸ“Š ì „ì </h3>
<button class="winBtn" onclick="addWin()">ìŠ¹</button>
<button class="loseBtn" onclick="addLose()">íŒ¨</button>
<div>ìŠ¹ <span id="win">0</span> / íŒ¨ <span id="lose">0</span> / ìŠ¹ë¥  <span id="rate">0</span>%</div>
<button class="resetBtn" onclick="resetRecord()">ìŠ¹íŒ¨ ì´ˆê¸°í™” (ê´€ë¦¬ììš©)</button>

<div class="rank">
  <h3>ğŸ† ê°œì¸ ìŠ¹ë¥  TOP3</h3>
  <div id="rankBox"></div>
</div>

<button id="adminToggleBtn" class="adminToggle" onclick="toggleAdmin()">+ ê´€ë¦¬ììš©</button>

<div id="adminPanel" class="admin">
  <h3>ğŸ›  ê´€ë¦¬ì ìˆ˜ë™ ìˆ˜ì •</h3>
  <button onclick="adminAdjust('win',1)">ìŠ¹ +1</button>
  <button onclick="adminAdjust('win',-1)">ìŠ¹ -1</button>
  <button onclick="adminAdjust('lose',1)">íŒ¨ +1</button>
  <button onclick="adminAdjust('lose',-1)">íŒ¨ -1</button>
</div>

<div class="footer">ì œì‘ì : ë¶ˆë©¸</div>

</body>
</html>
