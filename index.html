<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ê¸¸ë“œì „ ê³µê²© ì¶”ì²œ</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getDatabase, ref, onValue, update, push, set, remove
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_PW = "1513";

let currentDefenseKey = "";
let currentAttackKey = "";

/* ë¹„ë°€ë²ˆí˜¸ ì²´í¬ */
function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
  if(pw !== ADMIN_PW){
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤");
    return false;
  }
  return true;
}

/* ë°©ì–´íŒ€ ë¶ˆëŸ¬ì˜¤ê¸° */
onValue(ref(db, "defenseTeams"), (snap) => {
  defenseSelect.innerHTML = "";
  const data = snap.val();
  if (!data) return;
  for (let k in data) {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = data[k].name;
    defenseSelect.appendChild(o);
  }
  loadAttackTeams(defenseSelect.value);
});

/* ë°©ì–´íŒ€ ì¶”ê°€ */
window.addDefenseTeam = () => {
  if (!checkPW()) return;
  if (!newDefenseName.value.trim()) return alert("ë°©ì–´íŒ€ ì´ë¦„ ì…ë ¥");
  set(push(ref(db,"defenseTeams")), { name:newDefenseName.value, attackTeams:{} });
  newDefenseName.value="";
};

/* ë°©ì–´íŒ€ ìˆ˜ì • / ì‚­ì œ */
window.editDefenseTeam = () => {
  if (!defenseSelect.value) return;
  if (!checkPW()) return;
  const name = prompt("ìƒˆ ë°©ì–´íŒ€ ì´ë¦„");
  if (!name) return;
  update(ref(db,"defenseTeams/"+defenseSelect.value),{name});
};

window.deleteDefenseTeam = () => {
  if (!defenseSelect.value) return;
  if (!checkPW()) return;
  if (!confirm("ë°©ì–´íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  remove(ref(db,"defenseTeams/"+defenseSelect.value));
};

/* ê³µê²©íŒ€ ë¶ˆëŸ¬ì˜¤ê¸° (ìŠ¹ë¥ ìˆœ + ğŸ”¥) */
window.loadAttackTeams = (defKey) => {
  currentDefenseKey = defKey;
  attackList.innerHTML="";

  onValue(ref(db,`defenseTeams/${defKey}/attackTeams`),(s)=>{
    const data = s.val();
    if(!data) return;

    const teams = Object.entries(data).map(([key, v]) => {
      const total = (v.win||0) + (v.lose||0);
      const rate = total === 0 ? 0 : Math.round((v.win/total)*100);
      return { key, ...v, rate };
    });

    teams.sort((a,b)=>b.rate - a.rate);

    teams.forEach(t=>{
      const b=document.createElement("button");
      const fire = t.rate >= 70 ? "ğŸ”¥ " : "";
      b.textContent = `${fire}${t.name} (${t.rate}%)`;
      b.onclick=()=>selectAttack(defKey,t.key);
      attackList.appendChild(b);
    });
  });
};

/* ê³µê²©íŒ€ ì¶”ê°€ */
window.addAttackTeam = () => {
  if(!checkPW()) return;
  if(!currentDefenseKey) return alert("ë°©ì–´íŒ€ ì„ íƒ");
  if(!newAttackName.value.trim()) return alert("ê³µê²©íŒ€ ì´ë¦„ ì…ë ¥");

  set(push(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams`)),{
    name:newAttackName.value,
    type:attackType.value,
    ring:ringRec.value,
    armor:armorRec.value,
    skill:skillOrder.value,
    win:0,
    lose:0
  });

  clearEditMode();
};

/* ê³µê²©íŒ€ ì„ íƒ */
window.selectAttack = (dKey,aKey) => {
  currentAttackKey=aKey;
  onValue(ref(db,`defenseTeams/${dKey}/attackTeams/${aKey}`),(s)=>{
    const d=s.val(); if(!d) return;

    const total = d.win + d.lose;
    const rateVal = total ? Math.round(d.win/total*100) : 0;

    typeView.textContent=d.type;
    ringView.textContent=d.ring;
    armorView.textContent=d.armor;
    skillView.textContent=d.skill;
    win.textContent=d.win;
    lose.textContent=d.lose;
    rate.textContent=rateVal;

    newAttackName.value=d.name;
    attackType.value=d.type;
    ringRec.value=d.ring;
    armorRec.value=d.armor;
    skillOrder.value=d.skill;

    setEditMode(true);
  });
};

/* ê³µê²©íŒ€ ìˆ˜ì • */
window.editAttackTeam = () => {
  if(!currentAttackKey) return alert("ê³µê²©íŒ€ ì„ íƒ");
  if(!checkPW()) return;
  if(!confirm("ë°˜ì§€ ì¥ë¹„ ìŠ¤ìˆœ ì •ë³´ê°€ ë³€ê²½ë©ë‹ˆë‹¤\nìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    name:newAttackName.value,
    type:attackType.value,
    ring:ringRec.value,
    armor:armorRec.value,
    skill:skillOrder.value
  });

  clearEditMode();
};

/* ê³µê²©íŒ€ ì‚­ì œ */
window.deleteAttackTeam = () => {
  if(!currentAttackKey) return;
  if(!checkPW()) return;
  if(!confirm("ê³µê²©íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  remove(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`));
  clearEditMode();
};

/* ìŠ¹íŒ¨ */
window.addWin = () => {
  if(!currentAttackKey) return;
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    win:+win.textContent+1
  });
};
window.addLose = () => {
  if(!currentAttackKey) return;
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    lose:+lose.textContent+1
  });
};

/* âœ… ìŠ¹/íŒ¨ ì´ˆê¸°í™” */
window.resetRecord = () => {
  if(!currentAttackKey) return alert("ê³µê²©íŒ€ ì„ íƒ");
  if(!checkPW()) return;
  if(!confirm("í•´ë‹¹ ê³µê²©íŒ€ì˜ ìŠ¹/íŒ¨ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    win:0,
    lose:0
  });
};

/* ìˆ˜ì • ëª¨ë“œ UI */
function setEditMode(on){
  editNotice.style.display = on ? "block" : "none";
  editBtn.classList.toggle("editing", on);
}
function clearEditMode(){
  currentAttackKey="";
  newAttackName.value="";
  ringRec.value="";
  armorRec.value="";
  skillOrder.value="";
  setEditMode(false);
}
</script>

<style>
body{background:#111;color:#fff;font-family:sans-serif;padding:12px}
input,select,textarea,button{width:100%;margin-top:8px;padding:12px;font-size:15px}
textarea{min-height:80px}
button{background:#333;color:#fff;border:none;border-radius:6px}
button.editing{background:#c0392b}
.notice{background:#222;color:#ff7675;padding:10px;border-radius:6px;margin-top:8px;display:none}
.stat{margin-top:8px}
.winBtn{background:#4aa3ff}
.loseBtn{background:#ff5c5c}
.resetBtn{background:#555}
</style>
</head>

<body>

<h3>â• ë°©ì–´íŒ€</h3>
<input id="newDefenseName" placeholder="ë°©ì–´íŒ€ ì´ë¦„">
<button onclick="addDefenseTeam()">ì¶”ê°€</button>
<button onclick="editDefenseTeam()">ìˆ˜ì •</button>
<button onclick="deleteDefenseTeam()">ì‚­ì œ</button>

<h3>ğŸ›¡ ë°©ì–´íŒ€ ì„ íƒ</h3>
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>

<h3>â• ê³µê²©íŒ€</h3>
<div id="editNotice" class="notice">âœ í˜„ì¬ ê³µê²©íŒ€ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤</div>

<input id="newAttackName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
<select id="attackType">
  <option value="ì†ê³µ">ì†ê³µ</option>
  <option value="ë‚´ì‹¤">ë‚´ì‹¤</option>
</select>
<input id="ringRec" placeholder="ë°˜ì§€ ì¶”ì²œ">
<textarea id="armorRec" placeholder="ë°©ì–´êµ¬ ì¶”ì²œ"></textarea>
<input id="skillOrder" placeholder="ìŠ¤í‚¬ ìˆœì„œ">

<button onclick="addAttackTeam()">ì¶”ê°€</button>
<button id="editBtn" onclick="editAttackTeam()">ìˆ˜ì •</button>
<button onclick="deleteAttackTeam()">ì‚­ì œ</button>

<h3>âš” ê³µê²©íŒ€ ëª©ë¡ (ìŠ¹ë¥ ìˆœ)</h3>
<div id="attackList"></div>

<h3>ğŸ“¦ ì„¸íŒ…</h3>
<div class="stat">íƒ€ì…: <span id="typeView"></span></div>
<div class="stat">ë°˜ì§€: <span id="ringView"></span></div>
<div class="stat">ë°©ì–´êµ¬: <span id="armorView"></span></div>
<div class="stat">ìŠ¤í‚¬ ìˆœì„œ: <span id="skillView"></span></div>

<h3>ğŸ“Š ì „ì </h3>
<button class="winBtn" onclick="addWin()">ìŠ¹</button>
<button class="loseBtn" onclick="addLose()">íŒ¨</button>
<button class="resetBtn" onclick="resetRecord()">ìŠ¹/íŒ¨ ì´ˆê¸°í™”</button>

<div class="stat">ìŠ¹ <span id="win">0</span> / íŒ¨ <span id="lose">0</span></div>
<div class="stat">ìŠ¹ë¥  <span id="rate">0</span>%</div>

</body>
</html>
