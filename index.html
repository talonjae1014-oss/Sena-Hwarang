<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ê¸¸ë“œì „ ê³µê²© ì¶”ì²œ</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getDatabase, ref, onValue, off, update, push, set, remove
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyACr8bD-ZrJTwXvyiQTrxacrsQshepRbB8",
  authDomain: "sena-hwarang.firebaseapp.com",
  databaseURL: "https://sena-hwarang-default-rtdb.firebaseio.com",
  projectId: "sena-hwarang",
  storageBucket: "sena-hwarang.firebasestorage.app",
  messagingSenderId: "374306466048",
  appId: "1:374306466048:web:a97a7bc4c9ea886e0a6be5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ADMIN_PW = "1513";

let currentDefenseKey = "";
let currentAttackKey = "";
let attackListenerRef = null;

/* ë¹„ë°€ë²ˆí˜¸ */
function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if(pw !== ADMIN_PW){
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤");
    return false;
  }
  return true;
}

/* ë°©ì–´íŒ€ ë¶ˆëŸ¬ì˜¤ê¸° */
onValue(ref(db,"defenseTeams"), snap=>{
  defenseSelect.innerHTML="";
  const d=snap.val(); if(!d) return;
  for(let k in d){
    const o=document.createElement("option");
    o.value=k; o.textContent=d[k].name;
    defenseSelect.appendChild(o);
  }
  loadAttackTeams(defenseSelect.value);
});

/* ê³µê²©íŒ€ ëª©ë¡ (ì¤‘ë³µ ë°©ì§€) */
window.loadAttackTeams = (defKey)=>{
  currentDefenseKey = defKey;
  attackList.innerHTML="";

  if(attackListenerRef){
    off(attackListenerRef);
  }

  attackListenerRef = ref(db,`defenseTeams/${defKey}/attackTeams`);

  onValue(attackListenerRef,snap=>{
    attackList.innerHTML="";
    const data=snap.val(); if(!data) return;

    const teams = Object.entries(data).map(([k,v])=>{
      const t=(v.win||0)+(v.lose||0);
      const r=t?Math.round(v.win/t*100):0;
      return {key:k,...v,rate:r};
    }).sort((a,b)=>b.rate-a.rate);

    teams.forEach(t=>{
      const b=document.createElement("button");
      b.textContent=`${t.rate>=70?"ğŸ”¥ ":""}${t.name} (${t.rate}%)`;
      b.onclick=()=>selectAttack(defKey,t.key);
      attackList.appendChild(b);
    });
  });
};

/* ê³µê²©íŒ€ ì„ íƒ */
window.selectAttack=(dKey,aKey)=>{
  currentAttackKey=aKey;
  onValue(ref(db,`defenseTeams/${dKey}/attackTeams/${aKey}`),s=>{
    const d=s.val(); if(!d) return;
    typeView.textContent=d.type;
    ringView.textContent=d.ring;
    armorView.textContent=d.armor;
    skillView.textContent=d.skill;
    win.textContent=d.win;
    lose.textContent=d.lose;
    rate.textContent=d.win+d.lose?Math.round(d.win/(d.win+d.lose)*100):0;
  });
};

/* ìŠ¹íŒ¨ */
window.addWin=()=>update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{win:+win.textContent+1});
window.addLose=()=>update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{lose:+lose.textContent+1});

/* ê´€ë¦¬ì ê¸°ëŠ¥ */
window.addDefenseTeam=()=>{ if(!checkPW())return; set(push(ref(db,"defenseTeams")),{name:newDefenseName.value,attackTeams:{}}); };
window.editDefenseTeam=()=>{ if(!checkPW())return; update(ref(db,"defenseTeams/"+defenseSelect.value),{name:prompt("ìƒˆ ì´ë¦„")}); };
window.deleteDefenseTeam=()=>{ if(!checkPW())return; remove(ref(db,"defenseTeams/"+defenseSelect.value)); };

window.addAttackTeam=()=>{
  if(!checkPW())return;
  set(push(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams`)),{
    name:newAttackName.value,
    type:attackType.value,
    ring:ringRec.value,
    armor:armorRec.value,
    skill:skillOrder.value,
    win:0,lose:0
  });
};
window.editAttackTeam=()=>{
  if(!checkPW())return;
  update(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`),{
    name:newAttackName.value,
    type:attackType.value,
    ring:ringRec.value,
    armor:armorRec.value,
    skill:skillOrder.value
  });
};
window.deleteAttackTeam=()=>{
  if(!checkPW())return;
  remove(ref(db,`defenseTeams/${currentDefenseKey}/attackTeams/${currentAttackKey}`));
};
</script>

<style>
body{background:#111;color:#fff;font-family:sans-serif;padding:12px}
button,input,select,textarea{width:100%;margin-top:8px;padding:12px}
.winBtn{background:#4aa3ff}
.loseBtn{background:#ff5c5c}
.admin{background:#2b2b00;border:2px solid #f1c40f;padding:12px;margin-top:20px}
.admin h3{color:#f1c40f}
</style>
</head>

<body>

<h3>ğŸ¯ ê³µê²©í•  ëŒ€ìƒ ì„ íƒ</h3>
<select id="defenseSelect" onchange="loadAttackTeams(this.value)"></select>

<h3>âš” ê³µê²©íŒ€ ëª©ë¡</h3>
<div id="attackList"></div>

<h3>ğŸ“¦ ì„¸íŒ…</h3>
<div>íƒ€ì… <span id="typeView"></span></div>
<div>ë°˜ì§€ <span id="ringView"></span></div>
<div>ë°©ì–´êµ¬ <span id="armorView"></span></div>
<div>ìŠ¤í‚¬ <span id="skillView"></span></div>

<h3>ğŸ“Š ì „ì </h3>
<button class="winBtn" onclick="addWin()">ìŠ¹</button>
<button class="loseBtn" onclick="addLose()">íŒ¨</button>
<div>ìŠ¹ <span id="win">0</span> / íŒ¨ <span id="lose">0</span> / ìŠ¹ë¥  <span id="rate">0</span>%</div>

<div class="admin">
<h3>ğŸ›  ê´€ë¦¬ììš©</h3>

<input id="newDefenseName" placeholder="ë°©ì–´íŒ€ ì´ë¦„">
<button onclick="addDefenseTeam()">ë°©ì–´íŒ€ ì¶”ê°€</button>
<button onclick="editDefenseTeam()">ë°©ì–´íŒ€ ìˆ˜ì •</button>
<button onclick="deleteDefenseTeam()">ë°©ì–´íŒ€ ì‚­ì œ</button>

<hr>

<input id="newAttackName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
<select id="attackType"><option>ì†ê³µ</option><option>ë‚´ì‹¤</option></select>
<input id="ringRec" placeholder="ë°˜ì§€ ì¶”ì²œ">
<textarea id="armorRec" placeholder="ë°©ì–´êµ¬ ì¶”ì²œ"></textarea>
<input id="skillOrder" placeholder="ìŠ¤í‚¬ ìˆœì„œ">

<button onclick="addAttackTeam()">ê³µê²©íŒ€ ì¶”ê°€</button>
<button onclick="editAttackTeam()">ê³µê²©íŒ€ ìˆ˜ì •</button>
<button onclick="deleteAttackTeam()">ê³µê²©íŒ€ ì‚­ì œ</button>
</div>

</body>
</html>
